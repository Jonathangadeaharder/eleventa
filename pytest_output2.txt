============================= test session starts =============================
platform win32 -- Python 3.11.9, pytest-8.3.5, pluggy-1.5.0
PySide6 6.5.3 -- Qt runtime 6.5.3 -- Qt compiled 6.5.3
rootdir: C:\Users\Jonandrop\Documents\eleventa
configfile: pytest.ini
testpaths: tests
plugins: anyio-4.9.0, cov-6.1.1, mock-3.14.0, pythonpath-0.7.3, qt-4.4.0, timeout-2.3.1, xdist-3.6.1
timeout: 10.0s
timeout method: thread
timeout func_only: False
collected 624 items

tests/core/models/test_customer.py::TestCustomerModel::test_customer_creation PASSED [  0%]
tests/core/models/test_customer.py::TestCustomerModel::test_customer_creation_defaults PASSED [  0%]
tests/core/models/test_department.py::test_department_initialization PASSED [  0%]
tests/core/models/test_department.py::test_department_initialization_with_defaults PASSED [  0%]
tests/core/models/test_department.py::test_department_initialization_some_values PASSED [  0%]
tests/core/models/test_error_models.py::TestProblemDetail::test_default_values PASSED [  0%]
tests/core/models/test_error_models.py::TestProblemDetail::test_basic_problem_detail PASSED [  1%]
tests/core/models/test_error_models.py::TestProblemDetail::test_validation_error_problem PASSED [  1%]
tests/core/models/test_error_models.py::TestProblemDetail::test_not_found_problem PASSED [  1%]
tests/core/models/test_error_models.py::TestProblemDetail::test_business_logic_problem PASSED [  1%]
tests/core/models/test_error_models.py::TestProblemDetail::test_server_error_problem PASSED [  1%]
tests/core/models/test_error_models.py::TestProblemDetail::test_partial_problem_detail PASSED [  1%]
tests/core/models/test_error_models.py::TestProblemDetail::test_model_serialization PASSED [  2%]
tests/core/models/test_error_models.py::TestProblemDetail::test_model_serialization_exclude_none PASSED [  2%]
tests/core/models/test_error_models.py::TestProblemDetail::test_model_creation_from_dict PASSED [  2%]
tests/core/models/test_error_models.py::TestProblemDetail::test_model_validation PASSED [  2%]
tests/core/models/test_error_models.py::TestProblemDetail::test_model_equality PASSED [  2%]
tests/core/models/test_error_models.py::TestProblemDetail::test_model_repr PASSED [  2%]
tests/core/models/test_inventory.py::TestInventoryMovement::test_inventory_movement_creation PASSED [  3%]
tests/core/models/test_invoice.py::TestInvoiceModel::test_invoice_creation PASSED [  3%]
tests/core/models/test_invoice.py::TestInvoiceModel::test_invoice_creation_with_all_fields PASSED [  3%]
tests/core/models/test_product.py::test_department_creation PASSED       [  3%]
tests/core/models/test_product.py::test_product_creation PASSED          [  3%]
tests/core/models/test_product.py::test_product_edge_cases PASSED        [  3%]
tests/core/models/test_product.py::test_department_edge_cases PASSED     [  4%]
tests/core/models/test_sale.py::TestSaleModels::test_sale_creation PASSED [  4%]
tests/core/models/test_sale.py::TestSaleModels::test_sale_creation_empty PASSED [  4%]
tests/core/models/test_sale.py::TestSaleModels::test_sale_item_creation PASSED [  4%]
tests/core/models/test_sale_model.py::test_saleitem_subtotal PASSED      [  4%]
tests/core/models/test_sale_model.py::test_sale_total_empty PASSED       [  4%]
tests/core/models/test_sale_model.py::test_sale_total_with_items PASSED  [  4%]
tests/core/models/test_user.py::TestUserModel::test_user_creation_defaults PASSED [  5%]
tests/core/models/test_user.py::TestUserModel::test_user_creation_with_id_and_inactive PASSED [  5%]
tests/core/services/test_cash_drawer_service.py::test_open_drawer PASSED [  5%]
tests/core/services/test_cash_drawer_service.py::test_open_drawer_already_open PASSED [  5%]
tests/core/services/test_cash_drawer_service.py::test_open_drawer_negative_amount PASSED [  5%]
tests/core/services/test_cash_drawer_service.py::test_add_cash PASSED    [  5%]
tests/core/services/test_cash_drawer_service.py::test_add_cash_drawer_not_open PASSED [  6%]
tests/core/services/test_cash_drawer_service.py::test_add_cash_negative_amount PASSED [  6%]
tests/core/services/test_cash_drawer_service.py::test_remove_cash PASSED [  6%]
tests/core/services/test_cash_drawer_service.py::test_remove_cash_drawer_not_open PASSED [  6%]
tests/core/services/test_cash_drawer_service.py::test_remove_cash_negative_amount PASSED [  6%]
tests/core/services/test_cash_drawer_service.py::test_remove_cash_insufficient_funds PASSED [  6%]
tests/core/services/test_cash_drawer_service.py::test_get_drawer_summary PASSED [  7%]
tests/core/services/test_corte_service.py::TestCorteService::test_calculate_corte_data PASSED [  7%]
tests/core/services/test_corte_service.py::TestCorteService::test_calculate_corte_data_invalid_period 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:47 [ WARNING] root:unit_of_work.py:109 - Exception in UnitOfWork, rolling back: End time must not be before start time
PASSED                                                                   [  7%]
tests/core/services/test_corte_service.py::TestCorteService::test_calculate_corte_data_repository_failure PASSED [  7%]
tests/core/services/test_corte_service.py::TestCorteService::test_calculate_sales_by_payment_type PASSED [  7%]
tests/core/services/test_corte_service.py::TestCorteService::test_calculate_starting_balance PASSED [  7%]
tests/core/services/test_corte_service.py::TestCorteService::test_register_closing_balance PASSED [  8%]
tests/core/services/test_customer_service.py::test_add_customer_success 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:47 [    INFO] CustomerService:customer_service.py:50 - Added customer: John Doe (ID: 1)
PASSED                                                                   [  8%]
tests/core/services/test_customer_service.py::test_add_customer_validation_missing_name 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:47 [ WARNING] root:unit_of_work.py:109 - Exception in UnitOfWork, rolling back: Customer name cannot be empty
PASSED                                                                   [  8%]
tests/core/services/test_customer_service.py::test_add_customer_validation_invalid_email 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:47 [ WARNING] root:unit_of_work.py:109 - Exception in UnitOfWork, rolling back: Invalid email format
PASSED                                                                   [  8%]
tests/core/services/test_customer_service.py::test_update_customer_success 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:47 [    INFO] CustomerService:customer_service.py:80 - Updated customer info: John Doe (ID: 1)
PASSED                                                                   [  8%]
tests/core/services/test_customer_service.py::test_update_customer_not_found PASSED [  8%]
tests/core/services/test_customer_service.py::test_update_customer_validation_empty_name 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:48 [ WARNING] root:unit_of_work.py:109 - Exception in UnitOfWork, rolling back: Customer name cannot be empty
PASSED                                                                   [  8%]
tests/core/services/test_customer_service.py::test_get_customer_by_id_success PASSED [  9%]
tests/core/services/test_customer_service.py::test_get_customer_by_id_not_found PASSED [  9%]
tests/core/services/test_customer_service.py::test_get_all_customers PASSED [  9%]
tests/core/services/test_customer_service.py::test_find_customer PASSED  [  9%]
tests/core/services/test_customer_service.py::test_delete_customer_success_no_balance 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:48 [    INFO] CustomerService:customer_service.py:108 - Deleting 0 payment records for customer 1
2025-07-18 15:02:48 [    INFO] CustomerService:customer_service.py:115 - Deleted customer ID: 1
PASSED                                                                   [  9%]
tests/core/services/test_customer_service.py::test_delete_customer_not_found 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:48 [ WARNING] CustomerService:customer_service.py:96 - Attempted to delete non-existent customer ID: 99
PASSED                                                                   [  9%]
tests/core/services/test_customer_service.py::test_delete_customer_with_balance PASSED [ 10%]
tests/core/services/test_customer_service.py::test_apply_payment_success 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:48 [    INFO] CustomerService:customer_service.py:176 - Applied payment 10 of 100.00 to customer 00000000-0000-0000-0000-000000000001. New balance: 100.00. User ID for CreditPayment: 5 (type: <class 'int'>)
PASSED                                                                   [ 10%]
tests/core/services/test_customer_service.py::test_apply_payment_customer_not_found PASSED [ 10%]
tests/core/services/test_customer_service.py::test_apply_payment_non_positive_amount 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:48 [ WARNING] root:unit_of_work.py:109 - Exception in UnitOfWork, rolling back: Payment amount must be positive.
2025-07-18 15:02:48 [ WARNING] root:unit_of_work.py:109 - Exception in UnitOfWork, rolling back: Payment amount must be positive.
PASSED                                                                   [ 10%]
tests/core/services/test_customer_service.py::test_increase_customer_debt_success 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:48 [    INFO] CustomerService:customer_service.py:204 - Increased debt for customer 1 by 25.00. New balance: -25.00
PASSED                                                                   [ 10%]
tests/core/services/test_customer_service.py::test_increase_customer_debt_customer_not_found PASSED [ 10%]
tests/core/services/test_customer_service.py::test_increase_customer_debt_non_positive_amount 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:48 [ WARNING] root:unit_of_work.py:109 - Exception in UnitOfWork, rolling back: Amount to increase debt must be positive.
2025-07-18 15:02:48 [ WARNING] root:unit_of_work.py:109 - Exception in UnitOfWork, rolling back: Amount to increase debt must be positive.
PASSED                                                                   [ 11%]
tests/core/services/test_customer_service.py::test_get_customer_payments_success PASSED [ 11%]
tests/core/services/test_customer_service.py::test_get_customer_payments_no_payments PASSED [ 11%]
tests/core/services/test_inventory_service.py::test_add_inventory_success PASSED [ 11%]
tests/core/services/test_inventory_service.py::test_add_inventory_zero_quantity PASSED [ 11%]
tests/core/services/test_inventory_service.py::test_add_inventory_negative_quantity PASSED [ 11%]
tests/core/services/test_inventory_service.py::test_add_inventory_product_not_found PASSED [ 12%]
tests/core/services/test_inventory_service.py::test_add_inventory_product_does_not_use_inventory PASSED [ 12%]
tests/core/services/test_inventory_service.py::test_adjust_inventory_success_positive PASSED [ 12%]
tests/core/services/test_inventory_service.py::test_adjust_inventory_success_negative PASSED [ 12%]
tests/core/services/test_inventory_service.py::test_adjust_inventory_zero_quantity PASSED [ 12%]
tests/core/services/test_inventory_service.py::test_adjust_inventory_negative_stock PASSED [ 12%]
tests/core/services/test_inventory_service.py::test_adjust_inventory_product_not_found PASSED [ 12%]
tests/core/services/test_inventory_service.py::test_adjust_inventory_product_no_inventory_control PASSED [ 13%]
tests/core/services/test_inventory_service.py::test_decrease_stock_for_sale_success PASSED [ 13%]
tests/core/services/test_inventory_service.py::test_decrease_stock_for_sale_product_not_found PASSED [ 13%]
tests/core/services/test_inventory_service.py::test_decrease_stock_for_sale_product_no_inventory PASSED [ 13%]
tests/core/services/test_inventory_service.py::test_decrease_stock_for_sale_insufficient_stock PASSED [ 13%]
tests/core/services/test_inventory_service.py::test_decrease_stock_for_sale_zero_quantity PASSED [ 13%]
tests/core/services/test_inventory_service.py::test_decrease_stock_for_sale_negative_quantity PASSED [ 14%]
tests/core/services/test_inventory_service.py::test_get_inventory_report PASSED [ 14%]
tests/core/services/test_inventory_service.py::test_get_low_stock_products PASSED [ 14%]
tests/core/services/test_inventory_service.py::test_get_inventory_movements_all PASSED [ 14%]
tests/core/services/test_inventory_service.py::test_get_inventory_movements_for_product PASSED [ 14%]
tests/core/services/test_invoicing_concurrency.py::test_create_invoice_integration PASSED [ 14%]
tests/core/services/test_invoicing_service.py::TestInvoicingService::test_create_invoice_already_exists PASSED [ 15%]
tests/core/services/test_invoicing_service.py::TestInvoicingService::test_create_invoice_customer_not_found PASSED [ 15%]
tests/core/services/test_invoicing_service.py::TestInvoicingService::test_create_invoice_from_sale_success PASSED [ 15%]
tests/core/services/test_invoicing_service.py::TestInvoicingService::test_create_invoice_no_customer PASSED [ 15%]
tests/core/services/test_invoicing_service.py::TestInvoicingService::test_create_invoice_sale_not_found PASSED [ 15%]
tests/core/services/test_invoicing_service.py::TestInvoicingService::test_determine_invoice_type PASSED [ 15%]
tests/core/services/test_invoicing_service.py::TestInvoicingService::test_generate_invoice_pdf 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:48 [    INFO] InvoicingService:invoicing_service.py:344 - Generating PDF: C:\Users\Jonandrop\AppData\Local\Temp\tmpqf9o1jqv.pdf
2025-07-18 15:02:48 [    INFO] InvoicingService:invoicing_service.py:449 - Successfully generated PDF: C:\Users\Jonandrop\AppData\Local\Temp\tmpqf9o1jqv.pdf
PASSED                                                                   [ 16%]
tests/core/services/test_invoicing_service.py::TestInvoicingService::test_generate_invoice_pdf_error_handling PASSED [ 16%]
tests/core/services/test_invoicing_service.py::TestInvoicingService::test_get_iva_rate PASSED [ 16%]
tests/core/services/test_invoicing_service.py::TestInvoicingService::test_get_next_invoice_number PASSED [ 16%]
tests/core/services/test_invoicing_service.py::TestInvoicingService::test_get_next_invoice_number_first_invoice PASSED [ 16%]
tests/core/services/test_invoicing_service_extra.py::test_generate_next_invoice_number_first PASSED [ 16%]
tests/core/services/test_invoicing_service_extra.py::test_generate_next_invoice_number_increment PASSED [ 16%]
tests/core/services/test_invoicing_service_extra.py::test_determine_invoice_type_various PASSED [ 17%]
tests/core/services/test_invoicing_service_extra.py::test_get_iva_rate_various PASSED [ 17%]
tests/core/services/test_invoicing_service_extra.py::test_create_invoice_sale_not_found PASSED [ 17%]
tests/core/services/test_invoicing_service_extra.py::test_create_invoice_already_has_invoice PASSED [ 17%]
tests/core/services/test_invoicing_service_extra.py::test_create_invoice_no_customer PASSED [ 17%]
tests/core/services/test_invoicing_service_extra.py::test_create_invoice_customer_not_found PASSED [ 17%]
tests/core/services/test_invoicing_service_extra.py::test_create_invoice_success PASSED [ 18%]
tests/core/services/test_invoicing_service_extra.py::test_create_invoice_duplicate_on_save 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:48 [ WARNING] InvoicingService:invoicing_service.py:122 - Caught error during invoice add for sale 60: ValueError - Duplicate entry in DB
PASSED                                                                   [ 18%]
tests/core/services/test_invoicing_service_extra.py::test_get_invoice_by_id_and_sale_id_and_all PASSED [ 18%]
tests/core/services/test_invoicing_service_integration.py::test_create_invoice_integration PASSED [ 18%]
tests/core/services/test_invoicing_service_integration.py::test_concurrent_invoice_creation 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:49 [   ERROR] root:repositories.py:1071 - Error adding invoice: Invoice for sale ID 1 already exists
2025-07-18 15:02:49 [ WARNING] InvoicingService:invoicing_service.py:122 - Caught error during invoice add for sale 1: ValueError - Invoice for sale ID 1 already exists
2025-07-18 15:02:49 [   ERROR] root:repositories.py:1071 - Error adding invoice: Invoice for sale ID 1 already exists
2025-07-18 15:02:49 [ WARNING] InvoicingService:invoicing_service.py:122 - Caught error during invoice add for sale 1: ValueError - Invoice for sale ID 1 already exists
PASSED                                                                   [ 18%]
tests/core/services/test_product_service.py::test_add_product_success 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:49 [    INFO] ProductService:product_service.py:67 - Adding product with code: P001
PASSED                                                                   [ 18%]
tests/core/services/test_product_service.py::test_add_product_basic_validation_fails[invalid_product0-Code cannot be empty] PASSED [ 19%]
tests/core/services/test_product_service.py::test_add_product_basic_validation_fails[invalid_product1-Description cannot be empty] PASSED [ 19%]
tests/core/services/test_product_service.py::test_add_product_basic_validation_fails[invalid_product2-Sell price must be positive] PASSED [ 19%]
tests/core/services/test_product_service.py::test_add_product_basic_validation_fails[invalid_product3-Cost price must be positive] PASSED [ 19%]
tests/core/services/test_product_service.py::test_add_product_basic_validation_fails[invalid_product4-Cost price cannot be zero] PASSED [ 19%]
tests/core/services/test_product_service.py::test_add_product_basic_validation_fails[invalid_product5-Sell price cannot be zero] PASSED [ 19%]
tests/core/services/test_product_service.py::test_add_product_duplicate_code_fails PASSED [ 20%]
tests/core/services/test_product_service.py::test_add_product_nonexistent_dept_fails PASSED [ 20%]
tests/core/services/test_product_service.py::test_update_product_success 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:49 [    INFO] ProductService:product_service.py:84 - Updating product with ID: 101
PASSED                                                                   [ 20%]
tests/core/services/test_product_service.py::test_update_product_validation_fails PASSED [ 20%]
tests/core/services/test_product_service.py::test_update_product_code_conflict_fails PASSED [ 20%]
tests/core/services/test_product_service.py::test_update_product_nonexistent_fails PASSED [ 20%]
tests/core/services/test_product_service.py::test_delete_product_success 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:49 [    INFO] ProductService:product_service.py:99 - Deleting product with ID: 201
2025-07-18 15:02:49 [    INFO] ProductService:product_service.py:99 - Deleting product with ID: 202
PASSED                                                                   [ 20%]
tests/core/services/test_product_service.py::test_delete_product_with_stock_fails PASSED [ 21%]
tests/core/services/test_product_service.py::test_delete_product_nonexistent 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:50 [ WARNING] ProductService:product_service.py:102 - Attempted to delete non-existent product with ID: 999
PASSED                                                                   [ 21%]
tests/core/services/test_product_service.py::test_find_product_calls_search PASSED [ 21%]
tests/core/services/test_product_service.py::test_find_product_calls_get_all PASSED [ 21%]
tests/core/services/test_product_service.py::test_add_department_success 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:50 [    INFO] ProductService:product_service.py:169 - Adding department with name: New Dept
PASSED                                                                   [ 21%]
tests/core/services/test_product_service.py::test_add_department_validation_fails[invalid_dept0-Name cannot be empty] PASSED [ 21%]
tests/core/services/test_product_service.py::test_add_department_duplicate_name_fails PASSED [ 22%]
tests/core/services/test_product_service.py::test_delete_department_success 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:50 [    INFO] ProductService:product_service.py:192 - Deleting department with ID: 10
PASSED                                                                   [ 22%]
tests/core/services/test_product_service.py::test_delete_department_in_use_fails PASSED [ 22%]
tests/core/services/test_product_service.py::test_get_all_departments PASSED [ 22%]
tests/core/services/test_product_service.py::test_update_department_success 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:50 [    INFO] ProductService:product_service.py:208 - Updating department with ID: 5
PASSED                                                                   [ 22%]
tests/core/services/test_product_service.py::test_update_department_validation_fails PASSED [ 22%]
tests/core/services/test_product_service.py::test_update_department_duplicate_name_fails PASSED [ 23%]
tests/core/services/test_product_service.py::test_update_department_nonexistent_fails PASSED [ 23%]
tests/core/services/test_product_service.py::test_product_service_integration 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:50 [    INFO] ProductService:product_service.py:169 - Adding department with name: IntegrationDept
2025-07-18 15:02:50 [    INFO] ProductService:product_service.py:67 - Adding product with code: INTEG01
2025-07-18 15:02:50 [ WARNING] root:unit_of_work.py:109 - Exception in UnitOfWork, rolling back: Department 'IntegrationDept' cannot be deleted, it is used by 1 product(s).
2025-07-18 15:02:50 [    INFO] ProductService:product_service.py:99 - Deleting product with ID: 1
2025-07-18 15:02:50 [    INFO] ProductService:product_service.py:192 - Deleting department with ID: 1
PASSED                                                                   [ 23%]
tests/core/services/test_product_service.py::test_update_prices_all_products 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:50 [    INFO] ProductService:product_service.py:227 - Fetching all products to update prices by 10%.
2025-07-18 15:02:50 [    INFO] ProductService:product_service.py:254 - Successfully updated prices for 2 products by 10%.
PASSED                                                                   [ 23%]
tests/core/services/test_product_service.py::test_update_prices_by_department 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:50 [    INFO] ProductService:product_service.py:224 - Fetching products for department ID: 1 to update prices by -20%.
2025-07-18 15:02:50 [    INFO] ProductService:product_service.py:254 - Successfully updated prices for 1 products by -20%.
PASSED                                                                   [ 23%]
tests/core/services/test_product_service.py::test_update_prices_no_products_found_all 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:50 [    INFO] ProductService:product_service.py:227 - Fetching all products to update prices by 10%.
2025-07-18 15:02:50 [    INFO] ProductService:product_service.py:231 - No products found to update.
PASSED                                                                   [ 23%]
tests/core/services/test_product_service.py::test_update_prices_no_products_found_department 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:50 [    INFO] ProductService:product_service.py:224 - Fetching products for department ID: 5 to update prices by 10%.
2025-07-18 15:02:50 [    INFO] ProductService:product_service.py:231 - No products found to update.
PASSED                                                                   [ 24%]
tests/core/services/test_product_service.py::test_update_prices_invalid_percentage[invalid_percentage0] PASSED [ 24%]
tests/core/services/test_product_service.py::test_update_prices_invalid_percentage[invalid_percentage1] PASSED [ 24%]
tests/core/services/test_product_service.py::test_update_prices_invalid_percentage[invalid_percentage2] PASSED [ 24%]
tests/core/services/test_product_service.py::test_update_prices_product_with_no_sell_price 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:50 [    INFO] ProductService:product_service.py:227 - Fetching all products to update prices by 10%.
2025-07-18 15:02:50 [    INFO] ProductService:product_service.py:254 - Successfully updated prices for 1 products by 10%.
PASSED                                                                   [ 24%]
tests/core/services/test_product_service.py::test_update_prices_rounding_and_zero_floor 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:50 [    INFO] ProductService:product_service.py:227 - Fetching all products to update prices by 10.555%.
2025-07-18 15:02:50 [    INFO] ProductService:product_service.py:254 - Successfully updated prices for 2 products by 10.555%.
2025-07-18 15:02:50 [    INFO] ProductService:product_service.py:227 - Fetching all products to update prices by -99.5%.
2025-07-18 15:02:50 [    INFO] ProductService:product_service.py:254 - Successfully updated prices for 1 products by -99.5%.
PASSED                                                                   [ 24%]
tests/core/services/test_product_service_departments.py::test_add_department_success 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:50 [    INFO] ProductService:product_service.py:169 - Adding department with name: Dept1
PASSED                                                                   [ 25%]
tests/core/services/test_product_service_departments.py::test_add_department_duplicate_name PASSED [ 25%]
tests/core/services/test_product_service_departments.py::test_get_all_departments PASSED [ 25%]
tests/core/services/test_product_service_departments.py::test_delete_department_nonexistent 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:51 [ WARNING] ProductService:product_service.py:184 - Attempted to delete non-existent department with ID: 99
PASSED                                                                   [ 25%]
tests/core/services/test_product_service_departments.py::test_delete_department_in_use_fails PASSED [ 25%]
tests/core/services/test_product_service_departments.py::test_delete_department_success 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:51 [    INFO] ProductService:product_service.py:192 - Deleting department with ID: 4
PASSED                                                                   [ 25%]
tests/core/services/test_product_service_departments.py::test_update_department_missing_id PASSED [ 25%]
tests/core/services/test_product_service_departments.py::test_update_department_not_found PASSED [ 26%]
tests/core/services/test_product_service_departments.py::test_update_department_validation_fails PASSED [ 26%]
tests/core/services/test_product_service_departments.py::test_update_department_success 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:51 [    INFO] ProductService:product_service.py:208 - Updating department with ID: 8
PASSED                                                                   [ 26%]
tests/core/services/test_receipt_generation.py::TestReceiptGeneration::test_generate_receipt_pdf_filename_format PASSED [ 26%]
tests/core/services/test_receipt_generation.py::TestReceiptGeneration::test_generate_receipt_pdf_sale_not_found PASSED [ 26%]
tests/core/services/test_receipt_generation.py::TestReceiptGeneration::test_generate_receipt_pdf_success PASSED [ 26%]
tests/core/services/test_receipt_generation.py::TestReceiptGeneration::test_generate_receipt_pdf_with_customer PASSED [ 27%]
tests/core/services/test_reporting_service.py::TestReportingService::test_get_sales_summary_by_period PASSED [ 27%]
tests/core/services/test_reporting_service.py::TestReportingService::test_get_sales_by_payment_type PASSED [ 27%]
tests/core/services/test_reporting_service.py::TestReportingService::test_get_sales_by_department PASSED [ 27%]
tests/core/services/test_reporting_service.py::TestReportingService::test_get_sales_by_customer PASSED [ 27%]
tests/core/services/test_reporting_service.py::TestReportingService::test_get_top_selling_products PASSED [ 27%]
tests/core/services/test_reporting_service.py::TestReportingService::test_calculate_profit_for_period PASSED [ 28%]
tests/core/services/test_reporting_service.py::TestReportingService::test_get_daily_sales_report PASSED [ 28%]
tests/core/services/test_reporting_service.py::TestReportingService::test_get_sales_trend PASSED [ 28%]
tests/core/services/test_reporting_service.py::TestReportingService::test_get_comparative_report PASSED [ 28%]
tests/core/services/test_reporting_service.py::test_print_report_methods[print_sales_by_period_report-ventas_por_periodo] PASSED [ 28%]
tests/core/services/test_reporting_service.py::test_print_report_methods[print_sales_by_department_report-ventas_por_departamento] PASSED [ 28%]
tests/core/services/test_reporting_service.py::test_print_report_methods[print_sales_by_customer_report-ventas_por_cliente] PASSED [ 29%]
tests/core/services/test_reporting_service.py::test_print_report_methods[print_top_products_report-top_productos] PASSED [ 29%]
tests/core/services/test_reporting_service.py::test_print_report_methods[print_profit_analysis_report-analisis_ganancias] PASSED [ 29%]
tests/core/services/test_reporting_service.py::test_print_report_failure PASSED [ 29%]
tests/core/services/test_sale_service.py::test_create_sale_success PASSED [ 29%]
tests/core/services/test_sale_service.py::test_create_sale_with_credit PASSED [ 29%]
tests/core/services/test_sale_service.py::test_get_sale_by_id PASSED     [ 29%]
tests/core/services/test_sale_service.py::test_generate_receipt_pdf PASSED [ 30%]
tests/core/services/test_user_service.py::test_add_user_with_valid_data_succeeds 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:52 [    INFO] UserService:user_service.py:52 - Creating new user: newuser
PASSED                                                                   [ 30%]
tests/core/services/test_user_service.py::test_add_user_with_existing_username_raises_error 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:52 [    INFO] UserService:user_service.py:44 - Username 'existinguser' already exists.
PASSED                                                                   [ 30%]
tests/core/services/test_user_service.py::test_add_user_with_empty_username_raises_error PASSED [ 30%]
tests/core/services/test_user_service.py::test_add_user_with_empty_password_raises_error PASSED [ 30%]
tests/core/services/test_user_service.py::test_authenticate_with_valid_credentials_succeeds 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:52 [    INFO] UserService:user_service.py:84 - Authentication successful for user: authuser
PASSED                                                                   [ 30%]
tests/core/services/test_user_service.py::test_authenticate_with_incorrect_password_returns_none 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:52 [    INFO] UserService:user_service.py:87 - Authentication failed for username 'authuser': incorrect password
PASSED                                                                   [ 31%]
tests/core/services/test_user_service.py::test_authenticate_with_nonexistent_user_returns_none 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:52 [    INFO] UserService:user_service.py:80 - Authentication failed for username 'nosuchuser': user not found or inactive
PASSED                                                                   [ 31%]
tests/core/services/test_user_service.py::test_authenticate_with_inactive_user_returns_none 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:52 [    INFO] UserService:user_service.py:80 - Authentication failed for username 'inactiveuser': user not found or inactive
PASSED                                                                   [ 31%]
tests/core/services/test_user_service.py::test_authenticate_with_empty_credentials_returns_none PASSED [ 31%]
tests/core/services/test_user_service.py::test_get_user_by_id_returns_user_when_exists PASSED [ 31%]
tests/core/services/test_user_service.py::test_get_user_by_username_returns_user_when_exists PASSED [ 31%]
tests/core/test_config.py::test_load_defaults_when_no_file PASSED        [ 32%]
tests/core/test_config.py::test_save_and_load_cycle PASSED               [ 32%]
tests/core/test_exceptions.py::test_application_error_base PASSED        [ 32%]
tests/core/test_exceptions.py::test_validation_error PASSED              [ 32%]
tests/core/test_exceptions.py::test_resource_not_found_error PASSED      [ 32%]
tests/core/test_exceptions.py::test_database_error_basic PASSED          [ 32%]
tests/core/test_exceptions.py::test_database_error_with_original PASSED  [ 33%]
tests/core/test_exceptions.py::test_authentication_error PASSED          [ 33%]
tests/core/test_exceptions.py::test_business_rule_error PASSED           [ 33%]
tests/core/test_exceptions.py::test_external_service_error_basic PASSED  [ 33%]
tests/core/test_exceptions.py::test_external_service_error_with_name PASSED [ 33%]
tests/core/utils/test_validation.py::test_validate_required_field_valid[some value-Nombre] PASSED [ 33%]
tests/core/utils/test_validation.py::test_validate_required_field_valid[123-ID] PASSED [ 33%]
tests/core/utils/test_validation.py::test_validate_required_field_valid[0-Cantidad] PASSED [ 34%]
tests/core/utils/test_validation.py::test_validate_required_field_valid[False-Activo] PASSED [ 34%]
tests/core/utils/test_validation.py::test_validate_required_field_invalid[None-Name-Name cannot be empty] PASSED [ 34%]
tests/core/utils/test_validation.py::test_validate_required_field_invalid[-Description-Description cannot be empty] PASSED [ 34%]
tests/core/utils/test_validation.py::test_validate_required_field_invalid[   -Code-Code cannot be empty] PASSED [ 34%]
tests/core/utils/test_validation.py::test_validate_positive_number_valid[value0-Precio] PASSED [ 34%]
tests/core/utils/test_validation.py::test_validate_positive_number_valid[value1-Descuento] PASSED [ 35%]
tests/core/utils/test_validation.py::test_validate_positive_number_valid[None-L\xedmite] PASSED [ 35%]
tests/core/utils/test_validation.py::test_validate_positive_number_invalid[value0-Quantity-Quantity must be positive] PASSED [ 35%]
tests/core/utils/test_validation.py::test_validate_positive_number_invalid[value1-Price-Price must be positive] PASSED [ 35%]
tests/core/utils/test_validation.py::test_validate_unique_field_not_exists PASSED [ 35%]
tests/core/utils/test_validation.py::test_validate_unique_field_exists_create PASSED [ 35%]
tests/core/utils/test_validation.py::test_validate_unique_field_exists_update PASSED [ 36%]
tests/core/utils/test_validation.py::test_validate_non_zero_quantity_valid[quantity0-venta] PASSED [ 36%]
tests/core/utils/test_validation.py::test_validate_non_zero_quantity_valid[quantity1-compra] PASSED [ 36%]
tests/core/utils/test_validation.py::test_validate_non_zero_quantity_invalid[quantity0-sale-Quantity for sale must be greater than zero] PASSED [ 36%]
tests/core/utils/test_validation.py::test_validate_non_zero_quantity_invalid[quantity1-adjustment-Quantity for adjustment must be greater than zero] PASSED [ 36%]
tests/core/utils/test_validation.py::test_validate_exists_true PASSED    [ 36%]
tests/core/utils/test_validation.py::test_validate_exists_false PASSED   [ 37%]
tests/core/utils/test_validation.py::test_validate_sufficient_stock_valid PASSED [ 37%]
tests/core/utils/test_validation.py::test_validate_sufficient_stock_invalid PASSED [ 37%]
tests/infrastructure/persistence/simple_test.py::test_simple PASSED      [ 37%]
tests/infrastructure/persistence/test_cash_drawer_repository.py::TestSQLiteCashDrawerRepository::setup_for_test PASSED [ 37%]
tests/infrastructure/persistence/test_cash_drawer_repository.py::TestSQLiteCashDrawerRepository::test_add_and_get_entry_by_id PASSED [ 37%]
tests/infrastructure/persistence/test_cash_drawer_repository.py::TestSQLiteCashDrawerRepository::test_get_entry_by_id_not_found PASSED [ 37%]
tests/infrastructure/persistence/test_cash_drawer_repository.py::TestSQLiteCashDrawerRepository::test_get_entries_by_date_range PASSED [ 38%]
tests/infrastructure/persistence/test_cash_drawer_repository.py::TestSQLiteCashDrawerRepository::test_get_entries_by_drawer_id PASSED [ 38%]
tests/infrastructure/persistence/test_cash_drawer_repository.py::TestSQLiteCashDrawerRepository::test_get_current_balance PASSED [ 38%]
tests/infrastructure/persistence/test_cash_drawer_repository.py::TestSQLiteCashDrawerRepository::test_get_current_balance_no_entries PASSED [ 38%]
tests/infrastructure/persistence/test_cash_drawer_repository.py::TestSQLiteCashDrawerRepository::test_is_drawer_open PASSED [ 38%]
tests/infrastructure/persistence/test_cash_drawer_repository.py::TestSQLiteCashDrawerRepository::test_get_today_entries PASSED [ 38%]
tests/infrastructure/persistence/test_cash_drawer_repository.py::TestSQLiteCashDrawerRepository::test_get_entries_by_type PASSED [ 39%]
tests/infrastructure/persistence/test_cash_drawer_repository.py::TestSQLiteCashDrawerRepository::test_get_last_start_entry PASSED [ 39%]
tests/infrastructure/persistence/test_cash_drawer_repository.py::TestSQLiteCashDrawerRepository::test_get_last_start_entry_none PASSED [ 39%]
tests/infrastructure/persistence/test_credit_payment_repository.py::test_add_and_get_credit_payment PASSED [ 39%]
tests/infrastructure/persistence/test_credit_payment_repository.py::test_get_credit_payments_for_customer PASSED [ 39%]
tests/infrastructure/persistence/test_credit_payment_repository.py::test_get_for_customer_empty PASSED [ 39%]
tests/infrastructure/persistence/test_credit_payment_repository.py::test_negative_payment_amount_raises_error PASSED [ 40%]
tests/infrastructure/persistence/test_credit_payment_repository.py::TestSqliteCreditPaymentRepository::test_add_credit_payment PASSED [ 40%]
tests/infrastructure/persistence/test_customer_repository.py::test_add_customer PASSED [ 40%]
tests/infrastructure/persistence/test_customer_repository.py::test_add_customer_duplicate_cuit 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:53 [   ERROR] root:repositories.py:928 - Error adding customer: Customer with CUIT 99887766 already exists
PASSED                                                                   [ 40%]
tests/infrastructure/persistence/test_customer_repository.py::test_add_customer_duplicate_email 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:53 [   ERROR] root:repositories.py:928 - Error adding customer: Customer with email unique.email@example.com already exists
PASSED                                                                   [ 40%]
tests/infrastructure/persistence/test_customer_repository.py::test_get_customer_by_id PASSED [ 40%]
tests/infrastructure/persistence/test_customer_repository.py::test_get_customer_by_id_not_found PASSED [ 41%]
tests/infrastructure/persistence/test_customer_repository.py::test_get_customer_by_cuit PASSED [ 41%]
tests/infrastructure/persistence/test_customer_repository.py::test_get_customer_by_cuit_not_found PASSED [ 41%]
tests/infrastructure/persistence/test_customer_repository.py::test_get_all_customers PASSED [ 41%]
tests/infrastructure/persistence/test_customer_repository.py::test_update_customer PASSED [ 41%]
tests/infrastructure/persistence/test_customer_repository.py::test_update_customer_not_found 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:54 [   ERROR] root:repositories.py:1005 - Error updating customer: Customer with ID f37dffaa-ae92-4a79-a09b-7e3d1e96a30a not found
PASSED                                                                   [ 41%]
tests/infrastructure/persistence/test_customer_repository.py::test_delete_customer PASSED [ 41%]
tests/infrastructure/persistence/test_customer_repository.py::test_delete_customer_not_found PASSED [ 42%]
tests/infrastructure/persistence/test_customer_repository.py::test_search_customer_by_name PASSED [ 42%]
tests/infrastructure/persistence/test_customer_repository.py::test_get_all_customers_pagination PASSED [ 42%]
tests/infrastructure/persistence/test_customer_repository.py::test_search_customers_filtering_and_sorting PASSED [ 42%]
tests/infrastructure/persistence/test_database.py::test_database_connection PASSED [ 42%]
tests/infrastructure/persistence/test_database.py::test_session_scope_success PASSED [ 42%]
tests/infrastructure/persistence/test_database.py::test_session_scope_rollback 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:54 [   ERROR] root:utils.py:102 - Error during session: Test exception. Rolling back.
PASSED                                                                   [ 43%]
tests/infrastructure/persistence/test_database.py::test_session_scope_rollback_data_consistency 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:54 [   ERROR] root:utils.py:102 - Error during session: Test exception. Rolling back.
PASSED                                                                   [ 43%]
tests/infrastructure/persistence/test_database.py::test_session_scope_commit_exception_consistency 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:54 [   ERROR] root:utils.py:96 - Error during session commit: (sqlite3.IntegrityError) UNIQUE constraint failed: test_items.id
[SQL: INSERT INTO test_items (id, name) VALUES (?, ?)]
[parameters: (2, 'duplicate')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-18 15:02:54 [   ERROR] root:utils.py:102 - Error during session: Database commit error: (sqlite3.IntegrityError) UNIQUE constraint failed: test_items.id
[SQL: INSERT INTO test_items (id, name) VALUES (?, ?)]
[parameters: (2, 'duplicate')]
(Background on this error at: https://sqlalche.me/e/20/gkpj). Rolling back.
PASSED                                                                   [ 43%]
tests/infrastructure/persistence/test_database_module.py::test_import_mappings_returns_models_module PASSED [ 43%]
tests/infrastructure/persistence/test_database_module.py::test_ensure_all_models_mapped PASSED [ 43%]
tests/infrastructure/persistence/test_database_module.py::test_create_all_tables_creates_model_tables PASSED [ 43%]
tests/infrastructure/persistence/test_database_module.py::test_init_db_calls_create_all PASSED [ 44%]
tests/infrastructure/persistence/test_database_operations.py::test_database_initialization PASSED [ 44%]
tests/infrastructure/persistence/test_database_operations.py::test_execute_query PASSED [ 44%]
tests/infrastructure/persistence/test_database_operations.py::test_execute_query_exception PASSED [ 44%]
tests/infrastructure/persistence/test_database_operations.py::test_execute_query_with_return PASSED [ 44%]
tests/infrastructure/persistence/test_database_operations.py::test_execute_many PASSED [ 44%]
tests/infrastructure/persistence/test_database_operations.py::test_get_last_row_id PASSED [ 45%]
tests/infrastructure/persistence/test_database_operations.py::test_close_connection PASSED [ 45%]
tests/infrastructure/persistence/test_database_operations.py::test_transaction_operations PASSED [ 45%]
tests/infrastructure/persistence/test_database_operations.py::test_create_engine_with_correct_url PASSED [ 45%]
tests/infrastructure/persistence/test_database_operations.py::test_session_creation PASSED [ 45%]
tests/infrastructure/persistence/test_database_operations.py::test_session_scope_provider_setup PASSED [ 45%]
tests/infrastructure/persistence/test_database_operations.py::test_init_db PASSED [ 45%]
tests/infrastructure/persistence/test_database_operations.py::test_ensure_all_models_mapped PASSED [ 46%]
tests/infrastructure/persistence/test_db_ops.py::test_simple PASSED      [ 46%]
tests/infrastructure/persistence/test_department_repository.py::test_add_department PASSED [ 46%]
tests/infrastructure/persistence/test_department_repository.py::test_add_department_duplicate_name PASSED [ 46%]
tests/infrastructure/persistence/test_department_repository.py::test_get_department_by_id PASSED [ 46%]
tests/infrastructure/persistence/test_department_repository.py::test_get_department_by_id_not_found PASSED [ 46%]
tests/infrastructure/persistence/test_department_repository.py::test_get_department_by_name PASSED [ 47%]
tests/infrastructure/persistence/test_department_repository.py::test_get_department_by_name_not_found PASSED [ 47%]
tests/infrastructure/persistence/test_department_repository.py::test_get_all_departments PASSED [ 47%]
tests/infrastructure/persistence/test_department_repository.py::test_update_department PASSED [ 47%]
tests/infrastructure/persistence/test_department_repository.py::test_delete_department PASSED [ 47%]
tests/infrastructure/persistence/test_department_repository.py::test_delete_department_with_linked_products_raises_error 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:55 [   ERROR] root:repositories.py:165 - Unexpected error deleting department 1: Departamento 1 no puede ser eliminado, est√ü en uso por 1 productos.
PASSED                                                                   [ 47%]
tests/infrastructure/persistence/test_inventory_repository.py::test_add_movement PASSED [ 48%]
tests/infrastructure/persistence/test_inventory_repository.py::test_get_movements_for_product PASSED [ 48%]
tests/infrastructure/persistence/test_inventory_repository.py::test_get_all_movements PASSED [ 48%]
tests/infrastructure/persistence/test_invoice_repository.py::test_add_and_get_invoice PASSED [ 48%]
tests/infrastructure/persistence/test_invoice_repository.py::test_get_all_invoices PASSED [ 48%]
tests/infrastructure/persistence/test_invoice_repository.py::test_duplicate_sale_id_raises_error 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:56 [   ERROR] root:repositories.py:1071 - Error adding invoice: Invoice for sale ID 1 already exists
PASSED                                                                   [ 48%]
tests/infrastructure/persistence/test_product_repository.py::test_add_product PASSED [ 49%]
tests/infrastructure/persistence/test_product_repository.py::test_add_product_duplicate_code PASSED [ 49%]
tests/infrastructure/persistence/test_product_repository.py::test_get_product_by_id PASSED [ 49%]
tests/infrastructure/persistence/test_product_repository.py::test_get_product_by_id_not_found PASSED [ 49%]
tests/infrastructure/persistence/test_product_repository.py::test_get_product_by_code PASSED [ 49%]
tests/infrastructure/persistence/test_product_repository.py::test_get_product_by_code_not_found PASSED [ 49%]
tests/infrastructure/persistence/test_product_repository.py::test_get_all_products PASSED [ 50%]
tests/infrastructure/persistence/test_product_repository.py::test_update_product PASSED [ 50%]
tests/infrastructure/persistence/test_product_repository.py::test_delete_product PASSED [ 50%]
tests/infrastructure/persistence/test_product_repository.py::test_search_product PASSED [ 50%]
tests/infrastructure/persistence/test_product_repository.py::test_update_stock PASSED [ 50%]
tests/infrastructure/persistence/test_product_repository.py::test_get_low_stock PASSED [ 50%]
tests/infrastructure/persistence/test_product_repository.py::test_get_all_products_filtered_and_paginated PASSED [ 50%]
tests/infrastructure/persistence/test_product_repository.py::test_get_all_products_sorting PASSED [ 51%]
tests/infrastructure/persistence/test_repository_base.py::test_repository_initialization PASSED [ 51%]
tests/infrastructure/persistence/test_repository_base.py::test_session_property PASSED [ 51%]
tests/infrastructure/persistence/test_repository_base.py::test_session_property_no_session PASSED [ 51%]
tests/infrastructure/persistence/test_repository_base.py::test_set_session PASSED [ 51%]
tests/infrastructure/persistence/test_repository_base.py::test_entity_to_domain PASSED [ 51%]
tests/infrastructure/persistence/test_repository_base.py::test_domain_to_entity PASSED [ 52%]
tests/infrastructure/persistence/test_repository_base.py::test_get_by_id PASSED [ 52%]
tests/infrastructure/persistence/test_repository_base.py::test_get_all PASSED [ 52%]
tests/infrastructure/persistence/test_repository_base.py::test_add PASSED [ 52%]
tests/infrastructure/persistence/test_repository_base.py::test_update PASSED [ 52%]
tests/infrastructure/persistence/test_repository_base.py::test_delete PASSED [ 52%]
tests/infrastructure/persistence/test_sale_repository.py::test_add_sale PASSED [ 53%]
tests/infrastructure/persistence/test_sale_repository.py::test_get_sales_summary_by_period PASSED [ 53%]
tests/infrastructure/persistence/test_sale_repository.py::test_get_sales_by_payment_type PASSED [ 53%]
tests/infrastructure/persistence/test_sale_repository.py::test_get_sales_by_department PASSED [ 53%]
tests/infrastructure/persistence/test_sale_repository.py::test_get_sales_by_customer PASSED [ 53%]
tests/infrastructure/persistence/test_sale_repository.py::test_get_top_selling_products PASSED [ 53%]
tests/infrastructure/persistence/test_sale_repository.py::test_calculate_profit_for_period PASSED [ 54%]
tests/infrastructure/persistence/test_sale_repository.py::test_get_sale_by_id PASSED [ 54%]
tests/infrastructure/persistence/test_sale_repository.py::test_get_sales_by_period_filtering PASSED [ 54%]
tests/infrastructure/persistence/test_sale_repository_fixed.py::test_calculate_profit_for_period PASSED [ 54%]
tests/infrastructure/persistence/test_simple2.py::test_simple PASSED     [ 54%]
tests/infrastructure/persistence/test_unit_of_work.py::TestUnitOfWork::test_unit_of_work_initialization PASSED [ 54%]
tests/infrastructure/persistence/test_unit_of_work.py::TestUnitOfWork::test_unit_of_work_context_manager PASSED [ 54%]
tests/infrastructure/persistence/test_unit_of_work.py::TestUnitOfWork::test_unit_of_work_convenience_function PASSED [ 55%]
tests/infrastructure/persistence/test_unit_of_work.py::TestUnitOfWork::test_unit_of_work_shared_session PASSED [ 55%]
tests/infrastructure/persistence/test_unit_of_work.py::TestUnitOfWork::test_unit_of_work_transaction_commit 
-------------------------------- live log call --------------------------------
2025-07-18 15:02:58 [ WARNING] root:unit_of_work.py:109 - Exception in UnitOfWork, rolling back: This Connection is closed
FAILED                                                                   [ 55%]
tests/infrastructure/persistence/test_unit_of_work.py::TestUnitOfWork::test_unit_of_work_transaction_rollback 
-------------------------------- live log call --------------------------------
2025-07-18 15:03:02 [ WARNING] root:unit_of_work.py:109 - Exception in UnitOfWork, rolling back: This Connection is closed
FAILED                                                                   [ 55%]
tests/infrastructure/persistence/test_unit_of_work.py::TestUnitOfWork::test_unit_of_work_manual_commit 
-------------------------------- live log call --------------------------------
2025-07-18 15:03:04 [ WARNING] root:unit_of_work.py:109 - Exception in UnitOfWork, rolling back: This Connection is closed
FAILED                                                                   [ 55%]
tests/infrastructure/persistence/test_unit_of_work.py::TestUnitOfWork::test_unit_of_work_manual_rollback 
-------------------------------- live log call --------------------------------
2025-07-18 15:03:06 [ WARNING] root:unit_of_work.py:109 - Exception in UnitOfWork, rolling back: This Connection is closed
FAILED                                                                   [ 55%]
tests/infrastructure/persistence/test_unit_of_work.py::TestUnitOfWork::test_unit_of_work_complex_operation 
-------------------------------- live log call --------------------------------
2025-07-18 15:03:09 [   ERROR] root:repositories.py:928 - Error adding customer: This Connection is closed
2025-07-18 15:03:09 [ WARNING] root:unit_of_work.py:109 - Exception in UnitOfWork, rolling back: This Connection is closed
FAILED                                                                   [ 56%]
tests/infrastructure/persistence/test_unit_of_work.py::test_unit_of_work_no_session_factory_error PASSED [ 56%]
tests/infrastructure/persistence/test_user_repository.py::TestUserRepository::test_add_user PASSED [ 56%]
tests/infrastructure/persistence/test_user_repository.py::TestUserRepository::test_add_user_duplicate_username 
-------------------------------- live log call --------------------------------
2025-07-18 15:03:12 [   ERROR] root:repositories.py:1230 - Error adding user: Username 'duplicate_user_test2' already exists.
PASSED                                                                   [ 56%]
tests/infrastructure/persistence/test_user_repository.py::TestUserRepository::test_get_user_by_id PASSED [ 56%]
tests/infrastructure/persistence/test_user_repository.py::TestUserRepository::test_get_user_by_id_not_found PASSED [ 56%]
tests/infrastructure/persistence/test_user_repository.py::TestUserRepository::test_get_user_by_username PASSED [ 57%]
tests/infrastructure/persistence/test_user_repository.py::TestUserRepository::test_get_user_by_username_not_found PASSED [ 57%]
tests/infrastructure/reporting/test_document_generator.py::TestDocumentPdfGenerator::test_init_with_store_info PASSED [ 57%]
tests/infrastructure/reporting/test_document_generator.py::TestDocumentPdfGenerator::test_init_without_store_info PASSED [ 57%]
tests/infrastructure/reporting/test_document_generator.py::TestDocumentPdfGenerator::test_init_with_none_config_values PASSED [ 57%]
tests/infrastructure/reporting/test_document_generator.py::TestDocumentPdfGenerator::test_generate_invoice_creates_file PASSED [ 57%]
tests/infrastructure/reporting/test_document_generator.py::TestDocumentPdfGenerator::test_generate_receipt_creates_file PASSED [ 58%]
tests/infrastructure/reporting/test_document_generator.py::TestDocumentPdfGenerator::test_generate_presupuesto_creates_file PASSED [ 58%]
tests/infrastructure/reporting/test_document_generator.py::TestDocumentPdfGenerator::test_format_currency_receipt PASSED [ 58%]
tests/infrastructure/reporting/test_document_generator.py::TestDocumentPdfGenerator::test_format_sale_date_receipt PASSED [ 58%]
tests/infrastructure/reporting/test_document_generator.py::TestDocumentPdfGenerator::test_generate_invoice_handles_errors 
-------------------------------- live log call --------------------------------
2025-07-18 15:03:13 [   ERROR] DocumentPdfGenerator:document_generator.py:181 - Error generating invoice PDF: PDF generation failed
PASSED                                                                   [ 58%]
tests/infrastructure/reporting/test_document_generator.py::TestDocumentPdfGenerator::test_invalid_output_path 
-------------------------------- live log call --------------------------------
2025-07-18 15:03:13 [   ERROR] DocumentPdfGenerator:document_generator.py:118 - Cannot create directory for C:\invalid\path\with<invalid>chars\file.pdf: Invalid characters in path: C:\invalid\path\with<invalid>chars
2025-07-18 15:03:13 [   ERROR] DocumentPdfGenerator:document_generator.py:181 - Error generating invoice PDF: Invalid characters in path: C:\invalid\path\with<invalid>chars
PASSED                                                                   [ 58%]
tests/infrastructure/reporting/test_document_generator.py::TestDocumentPdfGenerator::test_empty_invoice_data 
-------------------------------- live log call --------------------------------
2025-07-18 15:03:13 [   ERROR] DocumentPdfGenerator:document_generator.py:143 - Invoice data cannot be empty
PASSED                                                                   [ 58%]
tests/infrastructure/reporting/test_document_generator.py::TestDocumentPdfGenerator::test_missing_required_invoice_fields 
-------------------------------- live log call --------------------------------
2025-07-18 15:03:13 [   ERROR] DocumentPdfGenerator:document_generator.py:150 - Missing required field: total
PASSED                                                                   [ 59%]
tests/infrastructure/reporting/test_document_generator.py::TestDocumentPdfGenerator::test_locale_handling PASSED [ 59%]
tests/infrastructure/reporting/test_document_generator.py::TestDocumentPdfGenerator::test_logger_initialization PASSED [ 59%]
tests/infrastructure/reporting/test_invoice_builder.py::TestInvoiceBuilder::test_error_handling PASSED [ 59%]
tests/infrastructure/reporting/test_invoice_builder.py::TestInvoiceBuilder::test_generate_invoice_pdf_custom_store_and_unusual_customer PASSED [ 59%]
tests/infrastructure/reporting/test_invoice_builder.py::TestInvoiceBuilder::test_generate_invoice_pdf_multi_page PASSED [ 59%]
tests/infrastructure/reporting/test_invoice_builder.py::TestInvoiceBuilder::test_generate_invoice_pdf_success PASSED [ 60%]
tests/infrastructure/reporting/test_invoice_builder.py::TestInvoiceBuilder::test_generate_invoice_pdf_type_a PASSED [ 60%]
tests/infrastructure/reporting/test_invoice_builder.py::TestInvoiceBuilder::test_generate_invoice_pdf_without_cae PASSED [ 60%]
tests/infrastructure/reporting/test_invoice_builder.py::TestInvoiceBuilder::test_invoice_pdf_content PASSED [ 60%]
tests/infrastructure/reporting/test_print_utility.py::TestPrintManager::test_init PASSED [ 60%]
tests/infrastructure/reporting/test_print_utility.py::TestPrintManager::test_get_store_info PASSED [ 60%]
tests/infrastructure/reporting/test_print_utility.py::TestPrintManager::test_generate_report PASSED [ 61%]
tests/infrastructure/reporting/test_print_utility.py::TestPrintManager::test_generate_receipt PASSED [ 61%]
tests/infrastructure/reporting/test_print_utility.py::TestPrintManager::test_generate_invoice PASSED [ 61%]
tests/infrastructure/reporting/test_print_utility.py::TestPrintManager::test_generate_cash_drawer_report PASSED [ 61%]
tests/infrastructure/reporting/test_print_utility.py::TestPrintManager::test_open_pdf 
-------------------------------- live log call --------------------------------
2025-07-18 15:03:14 [ WARNING] root:print_utility.py:269 - _open_pdf received a relative path: test.pdf. This might lead to errors.
2025-07-18 15:03:14 [ WARNING] root:print_utility.py:269 - _open_pdf received a relative path: test.pdf. This might lead to errors.
2025-07-18 15:03:14 [ WARNING] root:print_utility.py:269 - _open_pdf received a relative path: test.pdf. This might lead to errors.
2025-07-18 15:03:14 [ WARNING] root:print_utility.py:269 - _open_pdf received a relative path: test.pdf. This might lead to errors.
PASSED                                                                   [ 61%]
tests/infrastructure/reporting/test_print_utility.py::TestPrintManager::test_print_to_printer PASSED [ 61%]
tests/infrastructure/reporting/test_print_utility.py::TestPrintManager::test_print_method 
-------------------------------- live log call --------------------------------
2025-07-18 15:03:14 [   ERROR] root:print_utility.py:116 - Invalid print type: INVALID_TYPE
PASSED                                                                   [ 62%]
tests/infrastructure/reporting/test_print_utility.py::TestPrintManager::test_singleton_instance PASSED [ 62%]
tests/infrastructure/reporting/test_receipt_builder.py::TestReceiptBuilder::test_format_currency PASSED [ 62%]
tests/infrastructure/reporting/test_receipt_builder.py::TestReceiptBuilder::test_format_item_row PASSED [ 62%]
tests/infrastructure/reporting/test_receipt_builder.py::TestReceiptBuilder::test_format_sale_date PASSED [ 62%]
tests/infrastructure/reporting/test_receipt_builder.py::TestReceiptBuilder::test_generate_receipt_pdf PASSED [ 62%]
tests/infrastructure/test_alembic_migrations.py::test_alembic_upgrade_head_on_fresh_db PASSED [ 62%]
tests/infrastructure/test_alembic_migrations.py::test_product_and_department_tables_schema PASSED [ 63%]
tests/infrastructure/test_alembic_migrations.py::test_invoice_table_schema PASSED [ 63%]
tests/infrastructure/test_table_deps.py::test_direct_table_creation PASSED [ 63%]
tests/infrastructure/test_table_deps.py::test_table_order_validation PASSED [ 63%]
tests/integration/test_app_initialization.py::TestIntegrationWithoutLoginPrompt::test_invoicing_service_in_test_mode PASSED [ 63%]
tests/integration/test_db_simple.py::test_db_import PASSED               [ 63%]
tests/integration/test_db_simple.py::test_simple_db_session FAILED       [ 64%]
tests/integration/test_end_to_end_flows.py::TestSalesEndToEndFlow::test_complete_sale_process FAILED [ 64%]
tests/integration/test_end_to_end_flows.py::TestSalesEndToEndFlow::test_sale_with_error_handling FAILED [ 64%]
tests/integration/test_end_to_end_flows.py::TestInvoicingEndToEndFlow::test_invoice_generation_from_sale FAILED [ 64%]
tests/integration/test_end_to_end_flows.py::TestConcurrencyAndEdgeCases::test_inventory_updates_during_concurrent_sales PASSED [ 64%]
tests/integration/test_end_to_end_flows.py::TestConcurrencyAndEdgeCases::test_simple_product_creation FAILED [ 64%]
tests/integration/test_invoicing_integration.py::TestInvoicingIntegration::test_create_invoice_from_sale PASSED [ 65%]
tests/integration/test_invoicing_integration.py::TestInvoicingIntegration::test_get_all_invoices PASSED [ 65%]
tests/integration/test_invoicing_integration.py::TestInvoicingIntegration::test_generate_invoice_pdf 
-------------------------------- live log call --------------------------------
2025-07-18 15:03:21 [    INFO] InvoicingService:invoicing_service.py:344 - Generating PDF: C:\Users\Jonandrop\AppData\Local\Temp\tmp86pjpblj.pdf
2025-07-18 15:03:21 [    INFO] InvoicingService:invoicing_service.py:449 - Successfully generated PDF: C:\Users\Jonandrop\AppData\Local\Temp\tmp86pjpblj.pdf
PASSED                                                                   [ 65%]
tests/integration/test_main_initialization.py::TestInvoicingServiceFixInMain::test_factory_approach PASSED [ 65%]
tests/integration/test_main_initialization.py::TestInvoicingServiceFixInMain::test_with_actual_repository PASSED [ 65%]
tests/integration/test_print_integration.py::test_cash_drawer_print_button PASSED [ 65%]
tests/integration/test_print_integration.py::test_cash_drawer_print_closed_drawer PASSED [ 66%]
tests/integration/test_print_integration.py::test_cash_drawer_print_error_handling PASSED [ 66%]
tests/integration/test_print_integration.py::test_corte_print_button PASSED [ 66%]
tests/integration/test_print_integration.py::test_corte_print_no_data PASSED [ 66%]
tests/integration/test_print_integration.py::test_corte_print_error_handling PASSED [ 66%]
tests/integration/test_products.py::test_product_model PASSED            [ 66%]
tests/integration/test_report_printing.py::test_report_view_print_button PASSED [ 66%]
tests/integration/test_report_printing.py::test_different_report_types_print_correctly PASSED [ 67%]
tests/integration/test_simple.py::test_simple PASSED                     [ 67%]
tests/integration/test_simple.py::test_import_exceptions PASSED          [ 67%]
tests/integration/test_simple.py::test_import_department PASSED          [ 67%]
tests/integration/test_user_integration.py::TestUserIntegration::test_add_user_valid_user_returns_user 
-------------------------------- live log call --------------------------------
2025-07-18 15:03:22 [ WARNING] root:unit_of_work.py:109 - Exception in UnitOfWork, rolling back: This Connection is closed
FAILED                                                                   [ 67%]
tests/integration/test_user_integration.py::TestUserIntegration::test_add_user_duplicate_username_raises_value_error 
-------------------------------- live log call --------------------------------
2025-07-18 15:03:24 [ WARNING] root:unit_of_work.py:109 - Exception in UnitOfWork, rolling back: This Connection is closed
FAILED                                                                   [ 67%]
tests/integration/test_user_integration.py::TestUserIntegration::test_authenticate_user_valid_credentials_returns_user 
-------------------------------- live log call --------------------------------
2025-07-18 15:03:25 [ WARNING] root:unit_of_work.py:109 - Exception in UnitOfWork, rolling back: This Connection is closed
FAILED                                                                   [ 68%]
tests/integration/test_user_integration.py::TestUserIntegration::test_authenticate_user_invalid_credentials_returns_none 
-------------------------------- live log call --------------------------------
2025-07-18 15:03:28 [ WARNING] root:unit_of_work.py:109 - Exception in UnitOfWork, rolling back: This Connection is closed
FAILED                                                                   [ 68%]
tests/minimal_test.py::test_minimal PASSED                               [ 68%]
tests/minimal_test.py::test_addition PASSED                              [ 68%]
tests/minimal_test.py::test_subtraction PASSED                           [ 68%]
tests/test_cash_drawer_dialogs_copy.py::TestOpenCashDrawerDialog::test_initialization PASSED [ 68%]
tests/test_cash_drawer_dialogs_copy.py::TestOpenCashDrawerDialog::test_accept_valid_amount PASSED [ 69%]
tests/test_cash_drawer_dialogs_copy.py::TestOpenCashDrawerDialog::test_accept_default_description PASSED [ 69%]
tests/test_cash_drawer_dialogs_copy.py::TestOpenCashDrawerDialog::test_service_error_on_accept PASSED [ 69%]
tests/test_cash_drawer_dialogs_copy.py::TestAddRemoveCashDialog::test_initialization_add PASSED [ 69%]
tests/test_cash_drawer_dialogs_copy.py::TestAddRemoveCashDialog::test_initialization_remove PASSED [ 69%]
tests/test_cash_drawer_dialogs_copy.py::TestAddRemoveCashDialog::test_accept_add_cash PASSED [ 69%]
tests/test_cash_drawer_dialogs_copy.py::TestAddRemoveCashDialog::test_accept_remove_cash PASSED [ 70%]
tests/test_cash_drawer_dialogs_copy.py::TestAddRemoveCashDialog::test_reject_missing_description PASSED [ 70%]
tests/test_cash_drawer_dialogs_copy.py::TestAddRemoveCashDialog::test_service_value_error_on_accept PASSED [ 70%]
tests/test_cash_drawer_dialogs_copy.py::TestCashDrawerHistoryDialog::test_apply_filter PASSED [ 70%]
tests/test_cash_drawer_dialogs_copy.py::TestCashDrawerHistoryDialog::test_service_error_on_filter PASSED [ 70%]
tests/test_cash_drawer_dialogs_copy.py::TestCashDrawerHistoryDialog::test_initialization_loads_today PASSED [ 70%]
tests/test_cash_drawer_dialogs_copy.py::TestCashDrawerHistoryDialog::test_summary_display_update PASSED [ 70%]
tests/test_qt_utils.py::test_wait_for_signal_timer PASSED                [ 71%]
tests/test_qt_utils.py::test_fake_network_access_manager PASSED          [ 71%]
tests/test_smoke.py::test_main_window_starts_and_shows PASSED            [ 71%]
tests/ui/dialogs/test_adjust_inventory_dialog.py::test_dialog_initialization PASSED [ 71%]
tests/ui/dialogs/test_adjust_inventory_dialog.py::test_update_result_label_increase PASSED [ 71%]
tests/ui/dialogs/test_adjust_inventory_dialog.py::test_update_result_label_decrease PASSED [ 71%]
tests/ui/dialogs/test_adjust_inventory_dialog.py::test_update_result_label_negative_stock PASSED [ 72%]
tests/ui/dialogs/test_adjust_inventory_dialog.py::test_accept_validation_quantity_zero PASSED [ 72%]
tests/ui/dialogs/test_adjust_inventory_dialog.py::test_accept_validation_no_reason PASSED [ 72%]
tests/ui/dialogs/test_adjust_inventory_dialog.py::test_accept_validation_negative_stock PASSED [ 72%]
tests/ui/dialogs/test_adjust_inventory_dialog.py::test_successful_increase_stock PASSED [ 72%]
tests/ui/dialogs/test_adjust_inventory_dialog.py::test_successful_decrease_stock PASSED [ 72%]
tests/ui/dialogs/test_adjust_inventory_dialog.py::test_service_error_handling PASSED [ 73%]
tests/ui/dialogs/test_customer_dialog.py::test_dialog_initialization_add_mode PASSED [ 73%]
tests/ui/dialogs/test_customer_dialog.py::test_dialog_initialization_edit_mode PASSED [ 73%]
tests/ui/dialogs/test_customer_dialog.py::test_validation_empty_name PASSED [ 73%]
tests/ui/dialogs/test_customer_dialog.py::test_validation_invalid_email PASSED [ 73%]
tests/ui/dialogs/test_customer_dialog.py::test_validation_empty_phone PASSED [ 73%]
tests/ui/dialogs/test_customer_dialog.py::test_validation_negative_credit_limit PASSED [ 74%]
tests/ui/dialogs/test_customer_dialog.py::test_successful_add_customer PASSED [ 74%]
tests/ui/dialogs/test_customer_dialog.py::test_successful_edit_customer PASSED [ 74%]
tests/ui/dialogs/test_customer_dialog.py::test_service_error_handling_add PASSED [ 74%]
tests/ui/dialogs/test_customer_dialog.py::test_service_error_handling_edit PASSED [ 74%]
tests/ui/dialogs/test_customer_dialog.py::test_cancel_dialog PASSED      [ 74%]
tests/ui/dialogs/test_customer_dialog.py::test_credit_limit_formatting PASSED [ 75%]
tests/ui/dialogs/test_customer_dialog.py::test_email_validation_accepts_valid_emails PASSED [ 75%]
tests/ui/dialogs/test_customer_dialog.py::test_phone_formatting PASSED   [ 75%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_init_simple_error PASSED [ 75%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_init_detailed_error PASSED [ 75%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_show_details_functionality PASSED [ 75%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_ok_button_closes_dialog PASSED [ 75%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_escape_key_closes_dialog PASSED [ 76%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_enter_key_closes_dialog PASSED [ 76%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_dialog_size_and_layout PASSED [ 76%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_dialog_with_empty_message PASSED [ 76%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_dialog_with_none_values PASSED [ 76%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_dialog_with_long_message PASSED [ 76%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_dialog_with_html_content PASSED [ 77%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_dialog_with_special_characters PASSED [ 77%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_dialog_modality PASSED [ 77%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_dialog_icon PASSED [ 77%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_dialog_focus_behavior PASSED [ 77%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_dialog_with_exception_object PASSED [ 77%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_dialog_accessibility PASSED [ 78%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_dialog_keyboard_navigation PASSED [ 78%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_dialog_resize_behavior PASSED [ 78%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_static_show_error_method PASSED [ 78%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_dialog_cleanup PASSED [ 78%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_dialog_with_various_inputs[Error 1-Message 1-None] PASSED [ 78%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_dialog_with_various_inputs[Error 2-Message 2-Details 2] PASSED [ 79%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_dialog_with_various_inputs[--] PASSED [ 79%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_dialog_with_various_inputs[Unicode: \u4e2d\u6587-Message: \xe1\xe9\xed\xf3\xfa-Details: \u20ac\xa3\xa5] PASSED [ 79%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_dialog_thread_safety PASSED [ 79%]
tests/ui/dialogs/test_error_dialog.py::TestErrorDialog::test_dialog_memory_usage PASSED [ 79%]
tests/ui/dialogs/test_login_dialog.py::test_dialog_initialization PASSED [ 79%]
tests/ui/dialogs/test_login_dialog.py::test_login_button_enabled_when_fields_filled PASSED [ 79%]
tests/ui/dialogs/test_login_dialog.py::test_successful_login PASSED      [ 80%]
tests/ui/dialogs/test_login_dialog.py::test_failed_login_invalid_credentials PASSED [ 80%]
tests/ui/dialogs/test_login_dialog.py::test_failed_login_inactive_user PASSED [ 80%]
tests/ui/dialogs/test_login_dialog.py::test_service_error_handling PASSED [ 80%]
tests/ui/dialogs/test_login_dialog.py::test_enter_key_triggers_login PASSED [ 80%]
tests/ui/dialogs/test_login_dialog.py::test_cancel_dialog PASSED         [ 80%]
tests/ui/dialogs/test_login_dialog.py::test_password_field_security PASSED [ 81%]
tests/ui/dialogs/test_login_dialog.py::test_username_case_insensitive PASSED [ 81%]
tests/ui/dialogs/test_login_dialog.py::test_multiple_failed_attempts PASSED [ 81%]
tests/ui/dialogs/test_login_dialog.py::test_remember_username_functionality PASSED [ 81%]
tests/ui/dialogs/test_login_dialog.py::test_show_hide_password_functionality PASSED [ 81%]
tests/ui/dialogs/test_product_dialog.py::test_dialog_initialization_add_mode PASSED [ 81%]
tests/ui/dialogs/test_product_dialog.py::test_dialog_initialization_edit_mode PASSED [ 82%]
tests/ui/dialogs/test_product_dialog.py::test_departments_loaded PASSED  [ 82%]
tests/ui/dialogs/test_product_dialog.py::test_service_validation_empty_code PASSED [ 82%]
tests/ui/dialogs/test_product_dialog.py::test_service_validation_empty_description PASSED [ 82%]
tests/ui/dialogs/test_product_dialog.py::test_service_validation_zero_cost_price PASSED [ 82%]
tests/ui/dialogs/test_product_dialog.py::test_service_validation_zero_sell_price PASSED [ 82%]
tests/ui/dialogs/test_product_dialog.py::test_successful_add_product PASSED [ 83%]
tests/ui/dialogs/test_product_dialog.py::test_successful_edit_product PASSED [ 83%]
tests/ui/dialogs/test_product_dialog.py::test_service_error_handling_add PASSED [ 83%]
tests/ui/dialogs/test_product_dialog.py::test_field_focus_on_validation_error PASSED [ 83%]
tests/ui/dialogs/test_product_dialog.py::test_duplicate_code_error_handling PASSED [ 83%]
tests/ui/dialogs/test_product_dialog.py::test_service_error_handling_edit PASSED [ 83%]
tests/ui/dialogs/test_product_dialog.py::test_cancel_dialog PASSED       [ 83%]
tests/ui/dialogs/test_product_dialog.py::test_uses_inventory_checkbox_behavior PASSED [ 84%]
tests/ui/dialogs/test_update_prices_dialog.py::test_dialog_creation_loads_departments PASSED [ 84%]
tests/ui/dialogs/test_update_prices_dialog.py::test_get_percentage_valid PASSED [ 84%]
tests/ui/dialogs/test_update_prices_dialog.py::test_get_percentage_invalid PASSED [ 84%]
tests/ui/dialogs/test_update_prices_dialog.py::test_accept_successful_update_all_departments PASSED [ 84%]
tests/ui/dialogs/test_update_prices_dialog.py::test_accept_successful_update_specific_department PASSED [ 84%]
tests/ui/dialogs/test_update_prices_dialog.py::test_accept_user_cancels_confirmation PASSED [ 85%]
tests/ui/dialogs/test_update_prices_dialog.py::test_accept_invalid_percentage_prevents_update PASSED [ 85%]
tests/ui/dialogs/test_update_prices_dialog.py::test_accept_service_raises_value_error PASSED [ 85%]
tests/ui/dialogs/test_update_prices_dialog.py::test_accept_service_raises_generic_exception PASSED [ 85%]
tests/ui/dialogs/test_update_prices_dialog.py::test_run_update_prices_dialog_accepted PASSED [ 85%]
tests/ui/dialogs/test_update_prices_dialog.py::test_run_update_prices_dialog_rejected PASSED [ 85%]
tests/ui/models/test_base_table_model.py::test_base_table_model_initialization PASSED [ 86%]
tests/ui/models/test_base_table_model.py::test_base_table_model_row_count PASSED [ 86%]
tests/ui/models/test_base_table_model.py::test_base_table_model_column_count PASSED [ 86%]
tests/ui/models/test_base_table_model.py::test_base_table_model_header_data_horizontal PASSED [ 86%]
tests/ui/models/test_base_table_model.py::test_base_table_model_header_data_out_of_bounds PASSED [ 86%]
tests/ui/models/test_base_table_model.py::test_base_table_model_header_data_vertical PASSED [ 86%]
tests/ui/models/test_base_table_model.py::test_base_table_model_header_data_other_role PASSED [ 87%]
tests/ui/models/test_base_table_model.py::test_base_table_model_update_data PASSED [ 87%]
tests/ui/models/test_base_table_model.py::test_base_table_model_get_item_at_row PASSED [ 87%]
tests/ui/models/test_base_table_model.py::test_base_table_model_get_item_at_row_out_of_bounds PASSED [ 87%]
tests/ui/models/test_base_table_model.py::test_concrete_table_model_data_method PASSED [ 87%]
tests/ui/styles/test_styles.py::test_colors_constants PASSED             [ 87%]
tests/ui/styles/test_styles.py::test_fonts_constants PASSED              [ 87%]
tests/ui/styles/test_styles.py::test_styles_templates PASSED             [ 88%]
tests/ui/styles/test_styles.py::test_apply_style_to_button PASSED        [ 88%]
tests/ui/styles/test_styles.py::test_apply_style_to_text_input PASSED    [ 88%]
tests/ui/styles/test_styles.py::test_apply_style_invalid_style PASSED    [ 88%]
tests/ui/styles/test_styles.py::test_style_integration_with_real_widgets PASSED [ 88%]
tests/ui/styles/test_styles.py::test_colors_in_style_templates PASSED    [ 88%]
tests/ui/test_filter_dropdowns.py::TestPeriodFilterWidget::test_widget_initialization PASSED [ 89%]
tests/ui/test_filter_dropdowns.py::TestPeriodFilterWidget::test_period_selection_today PASSED [ 89%]
tests/ui/test_filter_dropdowns.py::TestPeriodFilterWidget::test_period_selection_yesterday PASSED [ 89%]
tests/ui/test_filter_dropdowns.py::TestPeriodFilterWidget::test_period_selection_this_week PASSED [ 89%]
tests/ui/test_filter_dropdowns.py::TestPeriodFilterWidget::test_custom_period_selection PASSED [ 89%]
tests/ui/test_filter_dropdowns.py::TestPeriodFilterWidget::test_custom_date_application PASSED [ 89%]
tests/ui/test_filter_dropdowns.py::TestFilterDropdown::test_widget_initialization PASSED [ 90%]
tests/ui/test_filter_dropdowns.py::TestFilterDropdown::test_selection_change_signal PASSED [ 90%]
tests/ui/test_filter_dropdowns.py::TestFilterDropdown::test_get_selected_value PASSED [ 90%]
tests/ui/test_filter_dropdowns.py::TestFilterDropdown::test_get_selected_text PASSED [ 90%]
tests/ui/test_filter_dropdowns.py::TestFilterBoxWidget::test_widget_initialization PASSED [ 90%]
tests/ui/test_filter_dropdowns.py::TestFilterBoxWidget::test_add_widget PASSED [ 90%]
tests/ui/test_filter_dropdowns.py::TestFilterBoxWidget::test_add_separator PASSED [ 91%]
tests/ui/test_filter_dropdowns.py::TestFilterBoxWidget::test_add_stretch PASSED [ 91%]
tests/ui/test_keyboard_shortcuts.py::test_sales_view_shortcut_handling PASSED [ 91%]
tests/ui/test_minimal_widget.py::test_minimal_widget_instantiates PASSED [ 91%]
tests/ui/test_minimal_widget.py::test_button_click_updates_ui PASSED     [ 91%]
tests/ui/test_minimal_widget.py::test_service_interaction PASSED         [ 91%]
tests/ui/test_minimal_widget.py::test_widget_with_mocked_methods PASSED  [ 91%]
tests/ui/test_table_models.py::test_add_items_and_total PASSED           [ 92%]
tests/ui/test_table_models.py::test_add_duplicate_product_no_merge PASSED [ 92%]
tests/ui/test_table_models.py::test_customer_table_model_data_and_update PASSED [ 92%]
tests/ui/test_ui_noninteractive_components.py::test_base_table_model_basic PASSED [ 92%]
tests/ui/test_ui_noninteractive_components.py::test_product_table_model_display_and_alignment PASSED [ 92%]
tests/ui/test_ui_noninteractive_components.py::test_sale_item_table_model_operations PASSED [ 92%]
tests/ui/test_ui_noninteractive_components.py::test_report_table_model PASSED [ 93%]
tests/ui/test_ui_noninteractive_components.py::test_ui_utils_message_boxes PASSED [ 93%]
tests/ui/test_ui_noninteractive_components.py::test_ask_confirmation PASSED [ 93%]
tests/ui/test_ui_noninteractive_components.py::test_apply_standard_form_style PASSED [ 93%]
tests/ui/test_ui_noninteractive_components.py::test_customer_table_model_display_alignment_and_foreground PASSED [ 93%]
tests/ui/test_ui_noninteractive_components.py::test_cash_drawer_entry_table_model_display_and_alignment PASSED [ 93%]
tests/ui/views/test_sales_view.py::test_search_suggests_products PASSED  [ 94%]
tests/ui/views/test_sales_view.py::test_search_clears_suggestions_on_short_text PASSED [ 94%]
tests/ui/views/test_sales_view.py::test_search_no_results_populates_empty PASSED [ 94%]
tests/ui/views/test_sales_view.py::test_search_suggests_products_with_multiple_results PASSED [ 94%]
tests/ui/views/test_sales_view.py::test_search_suggests_products_with_no_results PASSED [ 94%]
tests/ui/views/test_sales_view.py::test_search_suggests_products_with_empty_text PASSED [ 94%]
tests/ui/views/test_sales_view.py::test_search_suggests_products_with_case_insensitive_search PASSED [ 95%]
tests/ui/views/test_sales_view.py::test_product_selected_from_combo_adds_to_sale PASSED [ 95%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_widget_initialization PASSED [ 95%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_custom_period_enables_dates PASSED [ 95%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_predefined_period_disables_dates PASSED [ 95%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_get_date_range_predefined[Hoy-0] PASSED [ 95%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_get_date_range_predefined[Ayer-1] PASSED [ 95%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_get_date_range_predefined[Esta semana-None] PASSED [ 96%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_get_date_range_predefined[Semana pasada-None] PASSED [ 96%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_get_date_range_predefined[Este mes-None] PASSED [ 96%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_get_date_range_predefined[Mes pasado-None] PASSED [ 96%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_get_date_range_predefined[Este a\xf1o-None] PASSED [ 96%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_get_date_range_predefined[A\xf1o pasado-None] PASSED [ 96%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_get_date_range_this_week PASSED [ 97%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_get_date_range_last_week PASSED [ 97%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_get_date_range_this_month PASSED [ 97%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_get_date_range_custom PASSED [ 97%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_get_date_range_custom_invalid_order PASSED [ 97%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_period_change_signal PASSED [ 97%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_date_change_signal PASSED [ 98%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_widget_has_filter_applied_signal PASSED [ 98%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_date_widgets_exist PASSED [ 98%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_signal_connections PASSED [ 98%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_date_fields_enabled_state[Hoy-False] PASSED [ 98%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_date_fields_enabled_state[Ayer-False] PASSED [ 98%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_date_fields_enabled_state[Esta semana-False] PASSED [ 99%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_date_fields_enabled_state[Semana pasada-False] PASSED [ 99%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_date_fields_enabled_state[Este mes-False] PASSED [ 99%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_date_fields_enabled_state[Mes pasado-False] PASSED [ 99%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_date_fields_enabled_state[Este a\xf1o-False] PASSED [ 99%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_date_fields_enabled_state[A\xf1o pasado-False] PASSED [ 99%]
tests/ui/widgets/test_filter_dropdowns.py::TestPeriodFilterWidget::test_date_fields_enabled_state[Personalizado-True] PASSED [100%]

================================== FAILURES ===================================
_____________ TestUnitOfWork.test_unit_of_work_transaction_commit _____________

self = <test_unit_of_work.TestUnitOfWork object at 0x000001DCB3AD7FD0>
clean_db = (<sqlalchemy.orm.session.Session object at 0x000001DCB608CF50>, User(id=1, username='clean_db_testuser_d5fdf2b2', email=None, password_hash='hash', password=None, is_active=True, is_admin=True))

    def test_unit_of_work_transaction_commit(self, clean_db):
        """Test that successful operations are committed."""
        session, domain_user = clean_db
    
        # Create a department and product in the same transaction
        with UnitOfWork() as uow:
            # Add department
            department = Department(name="Test Department UoW")
>           created_dept = uow.departments.add(department)

tests\infrastructure\persistence\test_unit_of_work.py:86: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
infrastructure\persistence\sqlite\repositories.py:67: in add
    existing = self.get_by_name(department.name)
infrastructure\persistence\sqlite\repositories.py:101: in get_by_name
    department_orm = self.session.scalars(stmt).first()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2473: in scalars
    return self._execute_internal(
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
<string>:2: in _connection_for_bind
    ???
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:1242: in _connection_for_bind
    transaction = conn.begin()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:859: in begin
    self._transaction = RootTransaction(self)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2681: in __init__
    self._connection_begin_impl()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2699: in _connection_begin_impl
    self.connection._begin_impl(self)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:1107: in _begin_impl
    self._handle_dbapi_exception(e, None, None, None, None)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2355: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:1105: in _begin_impl
    self.engine.dialect.do_begin(self.connection)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:584: in connection
    return self._revalidate_connection()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.engine.base.Connection object at 0x000001DCB4A34650>

    def _revalidate_connection(self) -> PoolProxiedConnection:
        if self.__can_reconnect and self.invalidated:
            if self._transaction is not None:
                self._invalid_transaction()
            self._dbapi_connection = self.engine.raw_connection()
            return self._dbapi_connection
>       raise exc.ResourceClosedError("This Connection is closed")
E       sqlalchemy.exc.ResourceClosedError: This Connection is closed

..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:679: ResourceClosedError
------------------------------ Captured log call ------------------------------
WARNING  root:unit_of_work.py:109 Exception in UnitOfWork, rolling back: This Connection is closed
____________ TestUnitOfWork.test_unit_of_work_transaction_rollback ____________

self = <test_unit_of_work.TestUnitOfWork object at 0x000001DCB3AE0650>
clean_db = (<sqlalchemy.orm.session.Session object at 0x000001DCB4C3EB50>, User(id=1, username='clean_db_testuser_72b2108e', email=None, password_hash='hash', password=None, is_active=True, is_admin=True))

    def test_unit_of_work_transaction_rollback(self, clean_db):
        """Test that failed operations are rolled back."""
        session, domain_user = clean_db
    
        # First, create a department that will be used for conflict
        with UnitOfWork() as uow:
            department = Department(name="Conflict Department")
>           uow.departments.add(department)

tests\infrastructure\persistence\test_unit_of_work.py:117: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
infrastructure\persistence\sqlite\repositories.py:67: in add
    existing = self.get_by_name(department.name)
infrastructure\persistence\sqlite\repositories.py:101: in get_by_name
    department_orm = self.session.scalars(stmt).first()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2473: in scalars
    return self._execute_internal(
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
<string>:2: in _connection_for_bind
    ???
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:1242: in _connection_for_bind
    transaction = conn.begin()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:859: in begin
    self._transaction = RootTransaction(self)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2681: in __init__
    self._connection_begin_impl()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2699: in _connection_begin_impl
    self.connection._begin_impl(self)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:1107: in _begin_impl
    self._handle_dbapi_exception(e, None, None, None, None)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2355: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:1105: in _begin_impl
    self.engine.dialect.do_begin(self.connection)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:584: in connection
    return self._revalidate_connection()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.engine.base.Connection object at 0x000001DCB4A34650>

    def _revalidate_connection(self) -> PoolProxiedConnection:
        if self.__can_reconnect and self.invalidated:
            if self._transaction is not None:
                self._invalid_transaction()
            self._dbapi_connection = self.engine.raw_connection()
            return self._dbapi_connection
>       raise exc.ResourceClosedError("This Connection is closed")
E       sqlalchemy.exc.ResourceClosedError: This Connection is closed

..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:679: ResourceClosedError
------------------------------ Captured log call ------------------------------
WARNING  root:unit_of_work.py:109 Exception in UnitOfWork, rolling back: This Connection is closed
_______________ TestUnitOfWork.test_unit_of_work_manual_commit ________________

self = <test_unit_of_work.TestUnitOfWork object at 0x000001DCB3AE0C90>
clean_db = (<sqlalchemy.orm.session.Session object at 0x000001DCB4DAC950>, User(id=1, username='clean_db_testuser_fde6a936', email=None, password_hash='hash', password=None, is_active=True, is_admin=True))

    def test_unit_of_work_manual_commit(self, clean_db):
        """Test manual commit functionality."""
        session, domain_user = clean_db
    
        # Test that manual commit works
        with UnitOfWork() as uow:
            # Add a department
            department = Department(name="Manual Commit Dept")
>           created_dept = uow.departments.add(department)

tests\infrastructure\persistence\test_unit_of_work.py:147: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
infrastructure\persistence\sqlite\repositories.py:67: in add
    existing = self.get_by_name(department.name)
infrastructure\persistence\sqlite\repositories.py:101: in get_by_name
    department_orm = self.session.scalars(stmt).first()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2473: in scalars
    return self._execute_internal(
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
<string>:2: in _connection_for_bind
    ???
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:1242: in _connection_for_bind
    transaction = conn.begin()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:859: in begin
    self._transaction = RootTransaction(self)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2681: in __init__
    self._connection_begin_impl()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2699: in _connection_begin_impl
    self.connection._begin_impl(self)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:1107: in _begin_impl
    self._handle_dbapi_exception(e, None, None, None, None)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2355: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:1105: in _begin_impl
    self.engine.dialect.do_begin(self.connection)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:584: in connection
    return self._revalidate_connection()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.engine.base.Connection object at 0x000001DCB4A34650>

    def _revalidate_connection(self) -> PoolProxiedConnection:
        if self.__can_reconnect and self.invalidated:
            if self._transaction is not None:
                self._invalid_transaction()
            self._dbapi_connection = self.engine.raw_connection()
            return self._dbapi_connection
>       raise exc.ResourceClosedError("This Connection is closed")
E       sqlalchemy.exc.ResourceClosedError: This Connection is closed

..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:679: ResourceClosedError
------------------------------ Captured log call ------------------------------
WARNING  root:unit_of_work.py:109 Exception in UnitOfWork, rolling back: This Connection is closed
______________ TestUnitOfWork.test_unit_of_work_manual_rollback _______________

self = <test_unit_of_work.TestUnitOfWork object at 0x000001DCB3AE12D0>
clean_db = (<sqlalchemy.orm.session.Session object at 0x000001DCB60D1190>, User(id=1, username='clean_db_testuser_d319b480', email=None, password_hash='hash', password=None, is_active=True, is_admin=True))

    def test_unit_of_work_manual_rollback(self, clean_db):
        """Test manual rollback functionality."""
        session, domain_user = clean_db
    
        with UnitOfWork() as uow:
            # Add a department
            department = Department(name="Manual Rollback Dept")
>           uow.departments.add(department)

tests\infrastructure\persistence\test_unit_of_work.py:168: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
infrastructure\persistence\sqlite\repositories.py:67: in add
    existing = self.get_by_name(department.name)
infrastructure\persistence\sqlite\repositories.py:101: in get_by_name
    department_orm = self.session.scalars(stmt).first()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2473: in scalars
    return self._execute_internal(
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
<string>:2: in _connection_for_bind
    ???
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:1242: in _connection_for_bind
    transaction = conn.begin()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:859: in begin
    self._transaction = RootTransaction(self)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2681: in __init__
    self._connection_begin_impl()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2699: in _connection_begin_impl
    self.connection._begin_impl(self)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:1107: in _begin_impl
    self._handle_dbapi_exception(e, None, None, None, None)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2355: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:1105: in _begin_impl
    self.engine.dialect.do_begin(self.connection)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:584: in connection
    return self._revalidate_connection()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.engine.base.Connection object at 0x000001DCB4A34650>

    def _revalidate_connection(self) -> PoolProxiedConnection:
        if self.__can_reconnect and self.invalidated:
            if self._transaction is not None:
                self._invalid_transaction()
            self._dbapi_connection = self.engine.raw_connection()
            return self._dbapi_connection
>       raise exc.ResourceClosedError("This Connection is closed")
E       sqlalchemy.exc.ResourceClosedError: This Connection is closed

..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:679: ResourceClosedError
------------------------------ Captured log call ------------------------------
WARNING  root:unit_of_work.py:109 Exception in UnitOfWork, rolling back: This Connection is closed
_____________ TestUnitOfWork.test_unit_of_work_complex_operation ______________

self = <test_unit_of_work.TestUnitOfWork object at 0x000001DCB3AE1910>
clean_db = (<sqlalchemy.orm.session.Session object at 0x000001DCB6325250>, User(id=1, username='clean_db_testuser_8fbd8d6c', email=None, password_hash='hash', password=None, is_active=True, is_admin=True))

    def test_unit_of_work_complex_operation(self, clean_db):
        """Test a complex operation involving multiple repositories."""
        session, domain_user = clean_db
    
        with UnitOfWork() as uow:
            # Create customer
            customer = Customer(
                name="UoW Test Customer",
                email="uow@test.com",
                phone="123-456-7890",
                cuit="12345678"
            )
>           created_customer = uow.customers.add(customer)

tests\infrastructure\persistence\test_unit_of_work.py:199: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
infrastructure\persistence\sqlite\repositories.py:872: in add
    existing_cuit = self.session.execute(
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2365: in execute
    return self._execute_internal(
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
<string>:2: in _connection_for_bind
    ???
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:1242: in _connection_for_bind
    transaction = conn.begin()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:859: in begin
    self._transaction = RootTransaction(self)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2681: in __init__
    self._connection_begin_impl()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2699: in _connection_begin_impl
    self.connection._begin_impl(self)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:1107: in _begin_impl
    self._handle_dbapi_exception(e, None, None, None, None)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2355: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:1105: in _begin_impl
    self.engine.dialect.do_begin(self.connection)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:584: in connection
    return self._revalidate_connection()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.engine.base.Connection object at 0x000001DCB4A34650>

    def _revalidate_connection(self) -> PoolProxiedConnection:
        if self.__can_reconnect and self.invalidated:
            if self._transaction is not None:
                self._invalid_transaction()
            self._dbapi_connection = self.engine.raw_connection()
            return self._dbapi_connection
>       raise exc.ResourceClosedError("This Connection is closed")
E       sqlalchemy.exc.ResourceClosedError: This Connection is closed

..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:679: ResourceClosedError
------------------------------ Captured log call ------------------------------
ERROR    root:repositories.py:928 Error adding customer: This Connection is closed
WARNING  root:unit_of_work.py:109 Exception in UnitOfWork, rolling back: This Connection is closed
___________________________ test_simple_db_session ____________________________

clean_db = (<sqlalchemy.orm.session.Session object at 0x000001DCB645A110>, User(id=1, username='clean_db_testuser_86912ce0', email=None, password_hash='hash', password=None, is_active=True, is_admin=True))

    @pytest.mark.integration
    def test_simple_db_session(clean_db):
        """Test that we can get a clean database session."""
        # clean_db returns (session, user) tuple
        session, user = clean_db
    
        assert session is not None, "Clean database session should be available"
    
        # Try a simple operation using proper SQLAlchemy text() function
        # that doesn't rely on any particular table existing
        result = session.execute(text("SELECT 1")).scalar()
        assert result == 1, "Basic SQL query should work"
    
        # Verify user was created correctly
>       assert user.username == "testuser", "Test user should have correct username"
E       AssertionError: Test user should have correct username
E       assert 'clean_db_testuser_86912ce0' == 'testuser'
E         
E         - testuser
E         + clean_db_testuser_86912ce0

tests\integration\test_db_simple.py:35: AssertionError
______________ TestSalesEndToEndFlow.test_complete_sale_process _______________

self = <tests.integration.test_end_to_end_flows.TestSalesEndToEndFlow object at 0x000001DCB468D4D0>
test_app = {'external': {'filesystem': <external_service_mocks.mock_file_system.<locals>.MockFileSystem object at 0x000001DCB64E9...ct_service': <tests.integration.conftest.test_app.<locals>.TestProductService object at 0x000001DCB64E9BD0>, ...}, ...}
test_data_factory = <tests.integration.conftest.test_data_factory.<locals>.TestDataFactory object at 0x000001DCB64EB790>

    def test_complete_sale_process(self, test_app, test_data_factory):
        """
        Test a complete sale from product selection to receipt generation.
    
        This test verifies:
        - Product creation and retrieval
        - Inventory stock updates when sale happens
        - Customer selection and association
        - Sale creation with multiple items
        - Receipt generation
        """
        # Get services from the test app
        product_service = test_app["services"]["product_service"]
        sale_service = test_app["services"]["sale_service"]
        inventory_service = test_app["services"]["inventory_service"]
        customer_service = test_app["services"]["customer_service"]
    
        # Create test products
        product1 = test_data_factory.create_product(
            code="PROD001",
            description="Test Product 1",
            sell_price=100.00,
            quantity_in_stock=10
        )
    
        product2 = test_data_factory.create_product(
            code="PROD002",
            description="Test Product 2",
            sell_price=150.00,
            quantity_in_stock=5
        )
    
        # Create a test customer
        customer = test_data_factory.create_customer(
            name="End-to-End Test Customer",
            email="endtoend@test.com"
        )
    
        # Create a test user to ensure users table exists
        user = test_data_factory.create_user(
            username="test_sales_user",
            password_hash="$2b$12$test_hash_for_sales_process"
        )
    
        # Use the authenticated user from the test_app fixture
        # user = test_app["user"]  # Comment this out to use our newly created user instead
    
        # Setup inventory service mock for verification
        original_update_stock = inventory_service.update_stock_from_sale
        inventory_service.update_stock_from_sale = MagicMock()
    
        # Patch customer service to handle our test customer ID
        def mock_get_customer_by_id(customer_id):
            if customer_id == customer.id:
                return customer
            return None
    
        # Commit the session after creating test data to make it visible in the service's transaction
        test_app["session"].commit()
    
        # ---> ADD VERIFICATION HERE <---
        # Verify customer exists in the session *before* calling create_sale
        retrieved_customer_orm = test_app["session"].query(CustomerOrm).filter(CustomerOrm.id == customer.id).first()
        assert retrieved_customer_orm is not None, f"Customer {customer.id} not found in session before calling create_sale"
        assert str(retrieved_customer_orm.id) == str(customer.id)
    
        # Patch the customer_service.get_customer_by_id method on the instance within test_app
        # Note: This patch might be redundant now if committing solves the visibility issue, but keep for now.
        with patch.object(test_app["services"]["customer_service"], 'get_customer_by_id', side_effect=mock_get_customer_by_id):
    
            # Create a sale with multiple items
            sale_items = [
                {
                    "product_id": product1.id,
                    "product_code": product1.code,
                    "product_description": product1.description,
                    "quantity": 2,
                    "unit_price": product1.sell_price
                },
                {
                    "product_id": product2.id,
                    "product_code": product2.code,
                    "product_description": product2.description,
                    "quantity": 1,
                    "unit_price": product2.sell_price
                }
            ]
    
            # Process the sale - include user_id and payment_type
>           sale = sale_service.create_sale(
                items_data=sale_items,
                customer_id=customer.id,
                user_id=user.id,
                payment_type='Efectivo'
                )

tests\integration\test_end_to_end_flows.py:131: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
core\services\sale_service.py:34: in create_sale
    with unit_of_work() as uow:
C:\Program Files\WindowsApps\PythonSoftwareFoundation.Python.3.11_3.11.2544.0_x64__qbz5n2kfra8p0\Lib\contextlib.py:137: in __enter__
    return next(self.gen)
infrastructure\persistence\unit_of_work.py:195: in unit_of_work
    with UnitOfWork() as uow:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <infrastructure.persistence.unit_of_work.UnitOfWork object at 0x000001DCB64E5510>

    def __enter__(self):
        """Enter the Unit of Work context.
    
        Creates a new database session and initializes all repositories
        with the shared session.
    
        Returns:
            UnitOfWork: The Unit of Work instance with initialized repositories.
        """
        if self.session_factory is None:
>           raise ValueError(
                "No session factory has been set. Make sure to call "
                "session_scope_provider.set_default_session_factory() first."
            )
E           ValueError: No session factory has been set. Make sure to call session_scope_provider.set_default_session_factory() first.

infrastructure\persistence\unit_of_work.py:68: ValueError
_____________ TestSalesEndToEndFlow.test_sale_with_error_handling _____________

self = <tests.integration.test_end_to_end_flows.TestSalesEndToEndFlow object at 0x000001DCB468D8D0>
test_app = {'external': {'filesystem': <external_service_mocks.mock_file_system.<locals>.MockFileSystem object at 0x000001DCB614E...ct_service': <tests.integration.conftest.test_app.<locals>.TestProductService object at 0x000001DCB614F010>, ...}, ...}
test_data_factory = <tests.integration.conftest.test_data_factory.<locals>.TestDataFactory object at 0x000001DCB64EC190>

    def test_sale_with_error_handling(self, test_app, test_data_factory):
        """
        Test error handling during sale processing.
    
        This test verifies that:
        - Inventory can be properly tracked
        - We can catch and handle error conditions
        """
        # Get the session and services from test_app
        session = test_app["session"]
        product_service = test_app["services"]["product_service"]
        inventory_service = test_app["services"]["inventory_service"]
    
        # Create a product with limited stock
        product = test_data_factory.create_product(
            code="LIMITED",
            description="Limited Stock Product",
            sell_price=100.00,
            quantity_in_stock=3
        )
    
        # Flush changes to make them available within the transaction
        session.flush()
    
        # Manually verify the product exists and has the correct stock
>       retrieved_product = product_service.get_product_by_id(product.id)

tests\integration\test_end_to_end_flows.py:203: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
core\services\product_service.py:144: in get_product_by_id
    with unit_of_work() as uow:
C:\Program Files\WindowsApps\PythonSoftwareFoundation.Python.3.11_3.11.2544.0_x64__qbz5n2kfra8p0\Lib\contextlib.py:137: in __enter__
    return next(self.gen)
infrastructure\persistence\unit_of_work.py:195: in unit_of_work
    with UnitOfWork() as uow:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <infrastructure.persistence.unit_of_work.UnitOfWork object at 0x000001DCB64ECBD0>

    def __enter__(self):
        """Enter the Unit of Work context.
    
        Creates a new database session and initializes all repositories
        with the shared session.
    
        Returns:
            UnitOfWork: The Unit of Work instance with initialized repositories.
        """
        if self.session_factory is None:
>           raise ValueError(
                "No session factory has been set. Make sure to call "
                "session_scope_provider.set_default_session_factory() first."
            )
E           ValueError: No session factory has been set. Make sure to call session_scope_provider.set_default_session_factory() first.

infrastructure\persistence\unit_of_work.py:68: ValueError
_________ TestInvoicingEndToEndFlow.test_invoice_generation_from_sale _________

self = <tests.integration.test_end_to_end_flows.TestInvoicingEndToEndFlow object at 0x000001DCB468E210>
test_app = {'external': {'filesystem': <external_service_mocks.mock_file_system.<locals>.MockFileSystem object at 0x000001DCB6015...ct_service': <tests.integration.conftest.test_app.<locals>.TestProductService object at 0x000001DCB6014210>, ...}, ...}
test_data_factory = <tests.integration.conftest.test_data_factory.<locals>.TestDataFactory object at 0x000001DCB4DAF010>

    def test_invoice_generation_from_sale(self, test_app, test_data_factory):
        """
        Test complete invoice creation from a sale.
    
        This test verifies:
        - Sale creation with proper customer data
        - Invoice generation from the sale
        - PDF generation from invoice
        - Correct data propagation from sale to invoice
        """
        # Get services from the test app
        product_service = test_app["services"]["product_service"]
        sale_service = test_app["services"]["sale_service"]
        invoicing_service = test_app["services"]["invoicing_service"]
        customer_service = test_app["services"]["customer_service"]
        session = test_app["session"]
    
        # Create a test customer eligible for proper invoicing
        customer = test_data_factory.create_customer(
            name="Invoice Customer",
            email="invoice@example.com",
            cuit="20-12345678-9",
            iva_condition="Responsable Inscripto"
        )
    
        # Create test products
        product = test_data_factory.create_product(
            code="INV001",
            description="Invoice Test Product",
            sell_price=165.29,
            cost_price=100.00,
            quantity_in_stock=50
        )
    
        # Create a test user to ensure users table exists
        user = test_data_factory.create_user(
            username="test_invoice_user",
            password_hash="$2b$12$test_hash_for_invoice"
        )
    
        # Flush to ensure all entities are available within the transaction
        session.flush()
    
        # Create sale through sale_service
        from decimal import Decimal
    
        # Create items data as a list of dictionaries, matching what the service expects
        items_data = [
            {
                "product_id": product.id,
                "quantity": Decimal('2'),
                "product_code": product.code,
                "product_description": product.description,
                "unit_price": Decimal(str(product.sell_price))
            }
        ]
    
        # Use the sale service to create the sale
>       created_sale = sale_service.create_sale(
            items_data=items_data,
            user_id=user.id,
            payment_type='Efectivo',
            customer_id=customer.id
        )

tests\integration\test_end_to_end_flows.py:314: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
core\services\sale_service.py:34: in create_sale
    with unit_of_work() as uow:
C:\Program Files\WindowsApps\PythonSoftwareFoundation.Python.3.11_3.11.2544.0_x64__qbz5n2kfra8p0\Lib\contextlib.py:137: in __enter__
    return next(self.gen)
infrastructure\persistence\unit_of_work.py:195: in unit_of_work
    with UnitOfWork() as uow:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <infrastructure.persistence.unit_of_work.UnitOfWork object at 0x000001DCB4D8D690>

    def __enter__(self):
        """Enter the Unit of Work context.
    
        Creates a new database session and initializes all repositories
        with the shared session.
    
        Returns:
            UnitOfWork: The Unit of Work instance with initialized repositories.
        """
        if self.session_factory is None:
>           raise ValueError(
                "No session factory has been set. Make sure to call "
                "session_scope_provider.set_default_session_factory() first."
            )
E           ValueError: No session factory has been set. Make sure to call session_scope_provider.set_default_session_factory() first.

infrastructure\persistence\unit_of_work.py:68: ValueError
---------------------------- Captured stdout setup ----------------------------
Verifying mapping for 10 models...
Tables currently in Base.metadata: ['users', 'departments', 'products', 'inventory_movements', 'sales', 'sale_items', 'customers', 'credit_payments', 'invoices', 'cash_drawer_entries', 'test_items']
  - Model UserOrm correctly mapped to table 'users'
  - Model DepartmentOrm correctly mapped to table 'departments'
  - Model ProductOrm correctly mapped to table 'products'
  - Model InventoryMovementOrm correctly mapped to table 'inventory_movements'
  - Model SaleOrm correctly mapped to table 'sales'
  - Model SaleItemOrm correctly mapped to table 'sale_items'
  - Model CustomerOrm correctly mapped to table 'customers'
  - Model CreditPaymentOrm correctly mapped to table 'credit_payments'
  - Model InvoiceOrm correctly mapped to table 'invoices'
  - Model CashDrawerEntryOrm correctly mapped to table 'cash_drawer_entries'
Successfully verified 10 models mapped to 11 tables in Base.metadata.
All models mapped for TestInvoicingEndToEndFlow tests
__________ TestConcurrencyAndEdgeCases.test_simple_product_creation ___________

self = <tests.integration.test_end_to_end_flows.TestConcurrencyAndEdgeCases object at 0x000001DCB468F250>
test_app = {'external': {'filesystem': <external_service_mocks.mock_file_system.<locals>.MockFileSystem object at 0x000001DCB62DE...ct_service': <tests.integration.conftest.test_app.<locals>.TestProductService object at 0x000001DCB62DD690>, ...}, ...}
test_data_factory = <tests.integration.conftest.test_data_factory.<locals>.TestDataFactory object at 0x000001DCB4E0F650>

    @pytest.mark.integration
    def test_simple_product_creation(self, test_app, test_data_factory):
        """
        A simple test to verify product creation works correctly.
        This serves as a basic sanity check for database operations.
        """
        # Get the session from test_app
        session = test_app["session"]
    
        # Create a test user to ensure users table exists
        user = test_data_factory.create_user(
            username="test_product_creation_user",
            password_hash="$2b$12$test_hash_for_product_creation"
        )
    
        # Flush changes to make sure the user is available within the transaction
        session.flush()
    
        # Get product service
        product_service = test_app["services"]["product_service"]
    
        # Create a simple product
        product = test_data_factory.create_product(
            code="SIMPLE001",
            description="Simple Test Product",
            sell_price=50.00,
            cost_price=25.00,
            quantity_in_stock=100
        )
    
        # Print product ID and details for debugging
        print(f"Created product ID: {product.id}, type: {type(product.id)}")
    
        # Flush changes to make sure the product is available within the transaction
        session.flush()
    
        # Try directly querying the database to verify product existence
        from infrastructure.persistence.sqlite.models_mapping import ProductOrm
        from sqlalchemy import select
    
        stmt = select(ProductOrm).where(ProductOrm.id == product.id)
        result = session.execute(stmt).scalar_one_or_none()
    
        print(f"Direct DB query result: {result}")
        if result:
            print(f"Product in DB: ID={result.id}, Code={result.code}")
    
        # ---- Test 1: Use the service's method without session (should work with factory pattern) ----
        # The product_service is configured to use the test session via the factory pattern
>       retrieved_product = product_service.get_product_by_id(product.id)

tests\integration\test_end_to_end_flows.py:623: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
core\services\product_service.py:144: in get_product_by_id
    with unit_of_work() as uow:
C:\Program Files\WindowsApps\PythonSoftwareFoundation.Python.3.11_3.11.2544.0_x64__qbz5n2kfra8p0\Lib\contextlib.py:137: in __enter__
    return next(self.gen)
infrastructure\persistence\unit_of_work.py:195: in unit_of_work
    with UnitOfWork() as uow:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <infrastructure.persistence.unit_of_work.UnitOfWork object at 0x000001DCB4C47450>

    def __enter__(self):
        """Enter the Unit of Work context.
    
        Creates a new database session and initializes all repositories
        with the shared session.
    
        Returns:
            UnitOfWork: The Unit of Work instance with initialized repositories.
        """
        if self.session_factory is None:
>           raise ValueError(
                "No session factory has been set. Make sure to call "
                "session_scope_provider.set_default_session_factory() first."
            )
E           ValueError: No session factory has been set. Make sure to call session_scope_provider.set_default_session_factory() first.

infrastructure\persistence\unit_of_work.py:68: ValueError
---------------------------- Captured stdout call -----------------------------
Created product ID: 1, type: <class 'int'>
Direct DB query result: <ProductOrm(id=1, code='SIMPLE001', description='Simple Test Product')>
Product in DB: ID=1, Code=SIMPLE001
__________ TestUserIntegration.test_add_user_valid_user_returns_user __________

self = <tests.integration.test_user_integration.TestUserIntegration object at 0x000001DCB469C990>
user_service = <core.services.user_service.UserService object at 0x000001DCB64E4CD0>

    def test_add_user_valid_user_returns_user(self, user_service):
        """
        Test that adding a valid user returns a User object with an assigned ID
        and correct username and active status.
        """
        # Use timestamp to ensure unique username
        timestamp = int(time.time() * 1000)
        username = f"johndoe_{timestamp}"
    
>       new_user = user_service.add_user(username, "password123")

tests\integration\test_user_integration.py:52: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
core\services\user_service.py:42: in add_user
    existing_user = uow.users.get_by_username(username)
infrastructure\persistence\sqlite\repositories.py:1240: in get_by_username
    user_orm = self.session.query(UserOrm).filter(UserOrm.username == username).first()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\query.py:2759: in first
    return self.limit(1)._iter().first()  # type: ignore
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\query.py:2858: in _iter
    result: Union[ScalarResult[_T], Result[_T]] = self.session.execute(
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2365: in execute
    return self._execute_internal(
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
<string>:2: in _connection_for_bind
    ???
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:1242: in _connection_for_bind
    transaction = conn.begin()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:859: in begin
    self._transaction = RootTransaction(self)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2681: in __init__
    self._connection_begin_impl()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2699: in _connection_begin_impl
    self.connection._begin_impl(self)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:1107: in _begin_impl
    self._handle_dbapi_exception(e, None, None, None, None)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2355: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:1105: in _begin_impl
    self.engine.dialect.do_begin(self.connection)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:584: in connection
    return self._revalidate_connection()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.engine.base.Connection object at 0x000001DCB647ADD0>

    def _revalidate_connection(self) -> PoolProxiedConnection:
        if self.__can_reconnect and self.invalidated:
            if self._transaction is not None:
                self._invalid_transaction()
            self._dbapi_connection = self.engine.raw_connection()
            return self._dbapi_connection
>       raise exc.ResourceClosedError("This Connection is closed")
E       sqlalchemy.exc.ResourceClosedError: This Connection is closed

..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:679: ResourceClosedError
---------------------------- Captured stdout setup ----------------------------
Verifying mapping for 10 models...
Tables currently in Base.metadata: ['users', 'departments', 'products', 'inventory_movements', 'sales', 'sale_items', 'customers', 'credit_payments', 'invoices', 'cash_drawer_entries', 'test_items']
  - Model UserOrm correctly mapped to table 'users'
  - Model DepartmentOrm correctly mapped to table 'departments'
  - Model ProductOrm correctly mapped to table 'products'
  - Model InventoryMovementOrm correctly mapped to table 'inventory_movements'
  - Model SaleOrm correctly mapped to table 'sales'
  - Model SaleItemOrm correctly mapped to table 'sale_items'
  - Model CustomerOrm correctly mapped to table 'customers'
  - Model CreditPaymentOrm correctly mapped to table 'credit_payments'
  - Model InvoiceOrm correctly mapped to table 'invoices'
  - Model CashDrawerEntryOrm correctly mapped to table 'cash_drawer_entries'
Successfully verified 10 models mapped to 11 tables in Base.metadata.
All models mapped for TestUserIntegration tests
------------------------------ Captured log call ------------------------------
WARNING  root:unit_of_work.py:109 Exception in UnitOfWork, rolling back: This Connection is closed
___ TestUserIntegration.test_add_user_duplicate_username_raises_value_error ___

self = <tests.integration.test_user_integration.TestUserIntegration object at 0x000001DCB46B3550>
user_service = <core.services.user_service.UserService object at 0x000001DCB62DE510>

    def test_add_user_duplicate_username_raises_value_error(self, user_service):
        """
        Test that adding a user with a duplicate username raises a ValueError.
        """
        # Use timestamp to ensure unique username for first user
        timestamp = int(time.time() * 1000)
        username = f"dupuser_{timestamp}"
    
>       user_service.add_user(username, "pass1")

tests\integration\test_user_integration.py:70: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
core\services\user_service.py:42: in add_user
    existing_user = uow.users.get_by_username(username)
infrastructure\persistence\sqlite\repositories.py:1240: in get_by_username
    user_orm = self.session.query(UserOrm).filter(UserOrm.username == username).first()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\query.py:2759: in first
    return self.limit(1)._iter().first()  # type: ignore
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\query.py:2858: in _iter
    result: Union[ScalarResult[_T], Result[_T]] = self.session.execute(
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2365: in execute
    return self._execute_internal(
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
<string>:2: in _connection_for_bind
    ???
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:1242: in _connection_for_bind
    transaction = conn.begin()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:859: in begin
    self._transaction = RootTransaction(self)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2681: in __init__
    self._connection_begin_impl()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2699: in _connection_begin_impl
    self.connection._begin_impl(self)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:1107: in _begin_impl
    self._handle_dbapi_exception(e, None, None, None, None)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2355: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:1105: in _begin_impl
    self.engine.dialect.do_begin(self.connection)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:584: in connection
    return self._revalidate_connection()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.engine.base.Connection object at 0x000001DCB647ADD0>

    def _revalidate_connection(self) -> PoolProxiedConnection:
        if self.__can_reconnect and self.invalidated:
            if self._transaction is not None:
                self._invalid_transaction()
            self._dbapi_connection = self.engine.raw_connection()
            return self._dbapi_connection
>       raise exc.ResourceClosedError("This Connection is closed")
E       sqlalchemy.exc.ResourceClosedError: This Connection is closed

..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:679: ResourceClosedError
------------------------------ Captured log call ------------------------------
WARNING  root:unit_of_work.py:109 Exception in UnitOfWork, rolling back: This Connection is closed
__ TestUserIntegration.test_authenticate_user_valid_credentials_returns_user __

self = <tests.integration.test_user_integration.TestUserIntegration object at 0x000001DCB46B38D0>
user_service = <core.services.user_service.UserService object at 0x000001DCB66D34D0>

    def test_authenticate_user_valid_credentials_returns_user(self, user_service):
        """
        Test that authenticating with correct credentials returns the User.
        """
        # Use timestamp to ensure unique username
        timestamp = int(time.time() * 1000)
        username = f"authuser_{timestamp}"
    
>       created_user = user_service.add_user(username, "secret")

tests\integration\test_user_integration.py:83: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
core\services\user_service.py:42: in add_user
    existing_user = uow.users.get_by_username(username)
infrastructure\persistence\sqlite\repositories.py:1240: in get_by_username
    user_orm = self.session.query(UserOrm).filter(UserOrm.username == username).first()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\query.py:2759: in first
    return self.limit(1)._iter().first()  # type: ignore
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\query.py:2858: in _iter
    result: Union[ScalarResult[_T], Result[_T]] = self.session.execute(
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2365: in execute
    return self._execute_internal(
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
<string>:2: in _connection_for_bind
    ???
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:1242: in _connection_for_bind
    transaction = conn.begin()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:859: in begin
    self._transaction = RootTransaction(self)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2681: in __init__
    self._connection_begin_impl()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2699: in _connection_begin_impl
    self.connection._begin_impl(self)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:1107: in _begin_impl
    self._handle_dbapi_exception(e, None, None, None, None)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2355: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:1105: in _begin_impl
    self.engine.dialect.do_begin(self.connection)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:584: in connection
    return self._revalidate_connection()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.engine.base.Connection object at 0x000001DCB647ADD0>

    def _revalidate_connection(self) -> PoolProxiedConnection:
        if self.__can_reconnect and self.invalidated:
            if self._transaction is not None:
                self._invalid_transaction()
            self._dbapi_connection = self.engine.raw_connection()
            return self._dbapi_connection
>       raise exc.ResourceClosedError("This Connection is closed")
E       sqlalchemy.exc.ResourceClosedError: This Connection is closed

..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:679: ResourceClosedError
------------------------------ Captured log call ------------------------------
WARNING  root:unit_of_work.py:109 Exception in UnitOfWork, rolling back: This Connection is closed
_ TestUserIntegration.test_authenticate_user_invalid_credentials_returns_none _

self = <tests.integration.test_user_integration.TestUserIntegration object at 0x000001DCB46B3C90>
user_service = <core.services.user_service.UserService object at 0x000001DCB65F51D0>

    def test_authenticate_user_invalid_credentials_returns_none(self, user_service):
        """
        Test that authentication with invalid credentials returns None.
        """
        # Use timestamp to ensure unique username
        timestamp = int(time.time() * 1000)
        username = f"authfail_{timestamp}"
    
>       user_service.add_user(username, "goodpass")

tests\integration\test_user_integration.py:97: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
core\services\user_service.py:42: in add_user
    existing_user = uow.users.get_by_username(username)
infrastructure\persistence\sqlite\repositories.py:1240: in get_by_username
    user_orm = self.session.query(UserOrm).filter(UserOrm.username == username).first()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\query.py:2759: in first
    return self.limit(1)._iter().first()  # type: ignore
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\query.py:2858: in _iter
    result: Union[ScalarResult[_T], Result[_T]] = self.session.execute(
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2365: in execute
    return self._execute_internal(
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
<string>:2: in _connection_for_bind
    ???
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\orm\session.py:1242: in _connection_for_bind
    transaction = conn.begin()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:859: in begin
    self._transaction = RootTransaction(self)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2681: in __init__
    self._connection_begin_impl()
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2699: in _connection_begin_impl
    self.connection._begin_impl(self)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:1107: in _begin_impl
    self._handle_dbapi_exception(e, None, None, None, None)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:2355: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:1105: in _begin_impl
    self.engine.dialect.do_begin(self.connection)
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:584: in connection
    return self._revalidate_connection()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.engine.base.Connection object at 0x000001DCB647ADD0>

    def _revalidate_connection(self) -> PoolProxiedConnection:
        if self.__can_reconnect and self.invalidated:
            if self._transaction is not None:
                self._invalid_transaction()
            self._dbapi_connection = self.engine.raw_connection()
            return self._dbapi_connection
>       raise exc.ResourceClosedError("This Connection is closed")
E       sqlalchemy.exc.ResourceClosedError: This Connection is closed

..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\sqlalchemy\engine\base.py:679: ResourceClosedError
------------------------------ Captured log call ------------------------------
WARNING  root:unit_of_work.py:109 Exception in UnitOfWork, rolling back: This Connection is closed
============================== warnings summary ===============================
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\PySide6\QtTest.pyd:0
  C:\Users\Jonandrop\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\PySide6\QtTest.pyd:0: PytestCollectionWarning: cannot collect test class 'QTest' because it has a __new__ constructor (from: tests/ui/dialogs/test_error_dialog.py)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=============================== tests coverage ================================
_______________ coverage: platform win32, python 3.11.9-final-0 _______________

Name                                       Stmts   Miss  Cover
--------------------------------------------------------------
core\__init__.py                               1      0   100%
core\exceptions.py                            32      3    91%
core\interfaces\__init__.py                    0      0   100%
core\interfaces\repository_interfaces.py     147      8    95%
core\models\__init__.py                        9      0   100%
core\models\cash_drawer.py                    21      0   100%
core\models\credit_payment.py                 13      0   100%
core\models\customer.py                       15      0   100%
core\models\department.py                      7      0   100%
core\models\error_models.py                    9      0   100%
core\models\inventory.py                      14      0   100%
core\models\invoice.py                        21      0   100%
core\models\product.py                        45      1    98%
core\models\sale.py                           35      0   100%
core\models\user.py                           10      0   100%
core\services\__init__.py                      0      0   100%
core\services\cash_drawer_service.py          65      8    88%
core\services\corte_service.py                45      1    98%
core\services\customer_service.py            135     31    77%
core\services\inventory_service.py            78      2    97%
core\services\invoicing_service.py           205     31    85%
core\services\product_service.py             152     10    93%
core\services\reporting_service.py           171     14    92%
core\services\sale_service.py                164    112    32%
core\services\service_base.py                  6      0   100%
core\services\user_service.py                 16      1    94%
core\utils\__init__.py                         1      0   100%
core\utils\validation.py                      21      0   100%
--------------------------------------------------------------
TOTAL                                       1438    222    85%
Coverage HTML written to dir htmlcov
=========================== short test summary info ===========================
FAILED tests/infrastructure/persistence/test_unit_of_work.py::TestUnitOfWork::test_unit_of_work_transaction_commit
FAILED tests/infrastructure/persistence/test_unit_of_work.py::TestUnitOfWork::test_unit_of_work_transaction_rollback
FAILED tests/infrastructure/persistence/test_unit_of_work.py::TestUnitOfWork::test_unit_of_work_manual_commit
FAILED tests/infrastructure/persistence/test_unit_of_work.py::TestUnitOfWork::test_unit_of_work_manual_rollback
FAILED tests/infrastructure/persistence/test_unit_of_work.py::TestUnitOfWork::test_unit_of_work_complex_operation
FAILED tests/integration/test_db_simple.py::test_simple_db_session - Assertio...
FAILED tests/integration/test_end_to_end_flows.py::TestSalesEndToEndFlow::test_complete_sale_process
FAILED tests/integration/test_end_to_end_flows.py::TestSalesEndToEndFlow::test_sale_with_error_handling
FAILED tests/integration/test_end_to_end_flows.py::TestInvoicingEndToEndFlow::test_invoice_generation_from_sale
FAILED tests/integration/test_end_to_end_flows.py::TestConcurrencyAndEdgeCases::test_simple_product_creation
FAILED tests/integration/test_user_integration.py::TestUserIntegration::test_add_user_valid_user_returns_user
FAILED tests/integration/test_user_integration.py::TestUserIntegration::test_add_user_duplicate_username_raises_value_error
FAILED tests/integration/test_user_integration.py::TestUserIntegration::test_authenticate_user_valid_credentials_returns_user
FAILED tests/integration/test_user_integration.py::TestUserIntegration::test_authenticate_user_invalid_credentials_returns_none
================= 14 failed, 610 passed, 1 warning in 55.28s ==================
This plugin does not support grabbing the keyboard
